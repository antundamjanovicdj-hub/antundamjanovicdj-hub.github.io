<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LifeKompas</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;width:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}

/* ANDROID */
body{overflow-y:auto;-webkit-overflow-scrolling:touch}

/* iOS ONLY: sprjeƒçava zoom/scroll bugove */
@supports (-webkit-touch-callout:none){
  html,body{overflow:hidden}
  body{position:fixed;inset:0}
}

/* BACKGROUNDS */
body.home{
  background:linear-gradient(120deg,#1f6b4a,#2e8b57,#3fa37a,#2e8b57);
  background-size:400% 400%;
  animation:bgMove 12s ease-in-out infinite;
}
body.static{
  background:linear-gradient(to top,#d0f0c0,#a8e6cf,#61c09a,#2e8b57);
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

/* APP / SCREENS */
.app{position:relative;width:100%;height:100%}
.screen{
  position:absolute;inset:0;
  display:flex;justify-content:center;align-items:center;
  opacity:0;transform:translateY(20px);
  pointer-events:none;
  transition:.4s ease;
}
.screen.active{opacity:1;transform:translateY(0);pointer-events:auto}

/* CONTENT */
.content{width:100%;max-width:420px;padding:2rem 1.5rem;text-align:center}

/* TITLE */
.title{font-size:4rem;font-weight:900;line-height:1;margin-bottom:2rem}
.title span{
  display:block;
  background:linear-gradient(180deg,#000 40%,#ff8c00 60%,#ff4500);
  background-size:100% 200%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:fireGlow 3s ease-in-out infinite;
}
@keyframes fireGlow{
  0%{background-position:0% 0%}
  50%{background-position:0% 100%}
  100%{background-position:0% 0%}
}

/* BUTTONS */
.buttons{display:flex;flex-direction:column;gap:1rem;align-items:center}
.btn{
  width:100%;max-width:280px;
  padding:.9rem;border:none;border-radius:50px;
  font-size:1.1rem;font-weight:600;
  background:rgba(255,255,255,.85);
}

/* BACK */
.back-top{
  position:absolute;top:1rem;right:1rem;
  padding:.4rem .9rem;border:none;border-radius:20px;
  background:rgba(255,255,255,.9);font-weight:600;
}

/* INPUTS */
input,textarea,select{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  border:none;
  font-size:16px;
}
textarea{resize:vertical}

/* TASK */
.task{
  display:flex;
  gap:8px;
  align-items:flex-start;
  background:rgba(255,255,255,.85);
  border-radius:12px;
  padding:10px;
  margin-top:8px;
}
.task .meta{flex:1;text-align:left;font-size:.95rem}
.task .meta small{opacity:.75}
.task .actions{
  display:flex;
  gap:6px;
  align-items:center;
  margin-top:2px;
}
.task button{
  border:none;background:none;
  font-size:1.15rem;
  cursor:pointer;
}

/* Small helper text */
.help{
  font-size:.9rem;
  opacity:.85;
  margin-top:6px;
}
</style>
</head>

<body class="home">
<div class="app">

<!-- JEZIK -->
<div id="screen-lang" class="screen active">
  <div class="content">
    <h1 class="title"><span>Life</span><span>Kompas</span></h1>
    <div class="buttons">
      <button class="btn" onclick="selectLang('hr')">üá≠üá∑ Hrvatski</button>
      <button class="btn" onclick="selectLang('de')">üá©üá™ Deutsch</button>
      <button class="btn" onclick="selectLang('en')">üá¨üáß English</button>
    </div>
  </div>
</div>

<!-- MENU -->
<div id="screen-menu" class="screen">
  <button id="backBtn" class="back-top"></button>
  <div class="content">
    <div class="buttons">
      <button id="btnDiary" class="btn"></button>
      <button id="btnTasks" class="btn"></button>
    </div>
  </div>
</div>

<!-- DNEVNIK -->
<div id="screen-diary" class="screen">
  <button class="back-top" onclick="show('screen-menu')">‚Üê</button>
  <div class="content">
    <input type="date" id="dDate">
    <input type="text" id="dTitle">
    <textarea id="dText" rows="6"></textarea>

    <div class="buttons">
      <button class="btn" onclick="saveDiary()" id="btnSaveDiary"></button>
      <button class="btn" onclick="loadDiary()" id="btnEditDiary"></button>
      <button class="btn" onclick="deleteDiary()" id="btnDeleteDiary"></button>
    </div>
  </div>
</div>

<!-- OBVEZE -->
<div id="screen-tasks" class="screen">
  <button class="back-top" onclick="show('screen-menu')">‚Üê</button>
  <div class="content">
    <input type="text" id="taskTitle">
    <input type="date" id="taskDate">
    <input type="time" id="taskTime">

    <select id="taskReminder">
      <option value="0">‚Äî</option>
      <option value="15">15 min</option>
      <option value="30">30 min</option>
      <option value="60">1 h</option>
      <option value="1440">1 dan</option>
    </select>

    <button class="btn" onclick="saveTask()" id="btnAddTask"></button>
    <div class="help" id="notifHelp"></div>

    <div id="taskList"></div>
  </div>
</div>

</div>

<script>
/* =========================
   TRANSLATIONS
   ========================= */
const T={
 hr:{
  back:"‚Üê Povratak",
  diary:"üìî Dnevnik",
  tasks:"üìã Obveze",
  saveDiary:"üíæ Spremi",
  editDiary:"‚úèÔ∏è Uredi",
  deleteDiary:"üóë Izbri≈°i",
  addTask:"‚ûï Dodaj",
  saveTask:"üíæ Spremi izmjene",
  taskPlaceholder:"Naziv obveze (npr. Doktor)",
  reminderLabel:"Podsjetnik",
  none:"Bez podsjetnika",
  mins:"min prije",
  hour:"1 sat prije",
  day:"1 dan prije",
  calendar:"üìÖ Kalendar",
  notifHint:"üîî In-app podsjetnik radi dok je aplikacija otvorena. Za sigurnu notifikaciju koristi üìÖ Kalendar."
 },
 de:{
  back:"‚Üê Zur√ºck",
  diary:"üìî Tagebuch",
  tasks:"üìã Aufgaben",
  saveDiary:"üíæ Speichern",
  editDiary:"‚úèÔ∏è Bearbeiten",
  deleteDiary:"üóë L√∂schen",
  addTask:"‚ûï Hinzuf√ºgen",
  saveTask:"üíæ √Ñnderungen speichern",
  taskPlaceholder:"Aufgabe (z.B. Arzt)",
  reminderLabel:"Erinnerung",
  none:"Keine Erinnerung",
  mins:"Min vorher",
  hour:"1 Std vorher",
  day:"1 Tag vorher",
  calendar:"üìÖ Kalender",
  notifHint:"üîî In-App Erinnerung funktioniert, solange die App ge√∂ffnet ist. F√ºr sichere Benachrichtigung nutze üìÖ Kalender."
 },
 en:{
  back:"‚Üê Back",
  diary:"üìî Diary",
  tasks:"üìã Tasks",
  saveDiary:"üíæ Save",
  editDiary:"‚úèÔ∏è Edit",
  deleteDiary:"üóë Delete",
  addTask:"‚ûï Add",
  saveTask:"üíæ Save changes",
  taskPlaceholder:"Task title (e.g. Doctor)",
  reminderLabel:"Reminder",
  none:"No reminder",
  mins:"min before",
  hour:"1 hour before",
  day:"1 day before",
  calendar:"üìÖ Calendar",
  notifHint:"üîî In-app reminder works while the app is open. For reliable alerts use üìÖ Calendar."
 }
};

let lang="hr";

/* =========================
   STATE
   ========================= */
let tasks = [];
let editTaskId = null;

/* =========================
   NAV
   ========================= */
function show(id){
  document.activeElement.blur();
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function selectLang(l){
  lang=l;
  localStorage.setItem("lang",l);
  applyLang();
  document.body.className="static";
  show("screen-menu");
}

function applyLang(){
  backBtn.textContent = T[lang].back;
  btnDiary.textContent = T[lang].diary;
  btnTasks.textContent = T[lang].tasks;

  btnSaveDiary.textContent = T[lang].saveDiary;
  btnEditDiary.textContent = T[lang].editDiary;
  btnDeleteDiary.textContent = T[lang].deleteDiary;

  taskTitle.placeholder = T[lang].taskPlaceholder;
  btnAddTask.textContent = editTaskId ? T[lang].saveTask : T[lang].addTask;

  // reminder select labels
  taskReminder.options[0].textContent = "‚Äî " + T[lang].none;
  taskReminder.options[1].textContent = "15 " + T[lang].mins;
  taskReminder.options[2].textContent = "30 " + T[lang].mins;
  taskReminder.options[3].textContent = T[lang].hour;
  taskReminder.options[4].textContent = T[lang].day;

  notifHelp.textContent = T[lang].notifHint;
}

btnDiary.onclick=()=>{
  dDate.value=new Date().toISOString().slice(0,10);
  loadDiary();
  show("screen-diary");
};

btnTasks.onclick=()=>{
  loadTasks();
  show("screen-tasks");
};

backBtn.onclick=()=>{
  document.body.className="home";
  show("screen-lang");
};

/* =========================
   DIARY
   ========================= */
function saveDiary(){
  localStorage.setItem("diary-"+dDate.value, JSON.stringify({t:dTitle.value,x:dText.value}));
  alert("OK");
}
function loadDiary(){
  const s=localStorage.getItem("diary-"+dDate.value);
  if(!s) return;
  const e=JSON.parse(s);
  dTitle.value=e.t || "";
  dText.value=e.x || "";
}
function deleteDiary(){
  localStorage.removeItem("diary-"+dDate.value);
  dTitle.value="";
  dText.value="";
}

/* =========================
   TASKS
   ========================= */
function loadTasks(){
  tasks = JSON.parse(localStorage.getItem("tasks")||"[]");
  renderTasks();
}

function persistTasks(){
  localStorage.setItem("tasks", JSON.stringify(tasks));
}

function saveTask(){
  if(!taskTitle.value) return;

  const reminderMin = parseInt(taskReminder.value || "0", 10);

  if(editTaskId){
    const t = tasks.find(x=>x.id===editTaskId);
    if(t){
      t.t = taskTitle.value;
      t.d = taskDate.value;
      t.h = taskTime.value;
      t.r = reminderMin; // update reminder too (A)
    }
    editTaskId = null;
  } else {
    tasks.push({
      id: Date.now(),
      t: taskTitle.value,
      d: taskDate.value,
      h: taskTime.value,
      r: reminderMin // minutes before (0 = none)
    });
  }

  persistTasks();
  taskTitle.value=""; taskDate.value=""; taskTime.value=""; taskReminder.value="0";
  btnAddTask.textContent = T[lang].addTask;
  renderTasks();
  applyLang();
}

function editTask(id){
  const t = tasks.find(x=>x.id===id);
  if(!t) return;
  editTaskId = id;
  taskTitle.value = t.t || "";
  taskDate.value = t.d || "";
  taskTime.value = t.h || "";
  taskReminder.value = String(t.r || 0);
  btnAddTask.textContent = T[lang].saveTask;
}

function deleteTask(id){
  tasks = tasks.filter(t=>t.id!==id);
  persistTasks();
  renderTasks();
}

function doneTask(id){
  // Option B: done = remove
  deleteTask(id);
}

function formatReminderLabel(mins){
  if(!mins) return T[lang].none;
  if(mins===60) return T[lang].hour;
  if(mins===1440) return T[lang].day;
  return `${mins} ${T[lang].mins}`;
}

function renderTasks(){
  taskList.innerHTML = "";
  tasks.sort((a,b)=>(String(a.d||"") + String(a.h||"")).localeCompare(String(b.d||"") + String(b.h||"")));

  tasks.forEach(t=>{
    const div = document.createElement("div");
    div.className="task";
    const when = `${t.d||""} ${t.h||""}`.trim();
    const rem = formatReminderLabel(t.r||0);

    div.innerHTML = `
      <div class="meta">
        <div><strong>${escapeHtml(t.t||"")}</strong></div>
        <small>${escapeHtml(when)} ‚Ä¢ ${escapeHtml(rem)}</small>
      </div>
      <div class="actions">
        <button title="Edit" onclick="editTask(${t.id})">‚úèÔ∏è</button>
        <button title="Calendar" onclick="downloadICS(${t.id})">üìÖ</button>
        <button title="Done" onclick="doneTask(${t.id})">‚úî</button>
        <button title="Delete" onclick="deleteTask(${t.id})">üóë</button>
      </div>
    `;
    taskList.appendChild(div);
  });
}

/* =========================
   NOTIFICATIONS (In-app)
   ========================= */
async function ensureNotificationPermission(){
  if(!("Notification" in window)) return false;
  if(Notification.permission === "granted") return true;
  if(Notification.permission === "denied") return false;

  // tra≈æi dozvolu tek kad korisnik uƒëe u Obveze (nije naporno)
  try{
    const perm = await Notification.requestPermission();
    return perm === "granted";
  }catch{
    return false;
  }
}

// provjera svake minute: ako je obveza blizu i reminder je postavljen
// radi offline; najpouzdanije dok je app otvoren
const firedKey = "reminders_fired_v1"; // map to avoid duplicate alerts
function loadFiredMap(){
  try{ return JSON.parse(localStorage.getItem(firedKey)||"{}"); }catch{ return {}; }
}
function saveFiredMap(map){
  localStorage.setItem(firedKey, JSON.stringify(map));
}

function taskDueMillis(task){
  if(!task.d || !task.h) return null;
  const iso = `${task.d}T${task.h}:00`;
  const ms = Date.parse(iso);
  return Number.isFinite(ms) ? ms : null;
}

async function checkReminders(){
  const ok = await ensureNotificationPermission(); // may be false; still no crash
  const now = Date.now();
  const fired = loadFiredMap();

  // reload tasks from storage to ensure latest edits
  const current = JSON.parse(localStorage.getItem("tasks")||"[]");

  for(const t of current){
    const due = taskDueMillis(t);
    const r = parseInt(t.r||0,10);
    if(!due || !r) continue;

    const fireAt = due - r*60*1000;
    const windowMs = 60*1000; // 1 minute window

    if(now >= fireAt && now < fireAt + windowMs){
      const key = `${t.id}_${fireAt}`;
      if(fired[key]) continue;

      fired[key] = true;
      saveFiredMap(fired);

      if(ok){
        try{
          new Notification(T[lang].tasks, {
            body: `${t.t} ‚Ä¢ ${t.d} ${t.h}`,
            tag: key
          });
        }catch{
          alert(`üîî ${t.t}\n${t.d} ${t.h}`);
        }
      }else{
        // fallback when permission not granted
        alert(`üîî ${t.t}\n${t.d} ${t.h}`);
      }
    }
  }
}

/* Run reminders loop */
setInterval(checkReminders, 60*1000);

/* Ask permission when entering tasks screen */
const _origShow = show;
show = function(id){
  document.activeElement.blur();
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="screen-tasks"){
    // trigger permission ask once user is in tasks
    ensureNotificationPermission();
    // immediate check (so user doesn't wait 1 min)
    checkReminders();
  }
};

/* =========================
   CALENDAR EXPORT (.ics)
   Works on iOS + Android
   ========================= */
function pad(n){ return String(n).padStart(2,"0"); }
function toICSDateTime(dateStr, timeStr){
  // local time -> format: YYYYMMDDTHHMMSS
  const [y,m,d]=dateStr.split("-").map(Number);
  const [hh,mm]=timeStr.split(":").map(Number);
  return `${y}${pad(m)}${pad(d)}T${pad(hh)}${pad(mm)}00`;
}

function reminderToTriggerMinutes(mins){
  // VALARM TRIGGER is negative relative duration
  // e.g. -PT15M, -PT1H, -P1D
  if(!mins) return null;
  if(mins===1440) return "-P1D";
  if(mins===60) return "-PT1H";
  return `-PT${mins}M`;
}

function downloadICS(taskId){
  const t = tasks.find(x=>x.id===taskId) || JSON.parse(localStorage.getItem("tasks")||"[]").find(x=>x.id===taskId);
  if(!t || !t.d || !t.h) return;

  const dtStart = toICSDateTime(t.d, t.h);
  // default duration 30 min
  const dtEnd = dtStart; // keep same time; calendar can edit duration
  const uid = `${t.id}@lifekompas`;
  const stamp = new Date().toISOString().replace(/[-:]/g,"").split(".")[0] + "Z";
  const trigger = reminderToTriggerMinutes(parseInt(t.r||0,10));

  const lines = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//LifeKompas//Obveze//HR",
    "CALSCALE:GREGORIAN",
    "METHOD:PUBLISH",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${stamp}`,
    `DTSTART:${dtStart}`,
    `SUMMARY:${escapeICS(t.t||"Obveza")}`,
    "END:VEVENT",
    "END:VCALENDAR"
  ];

  // Insert VALARM if reminder set
  if(trigger){
    lines.splice(lines.indexOf("END:VEVENT"), 0,
      "BEGIN:VALARM",
      `TRIGGER:${trigger}`,
      "ACTION:DISPLAY",
      `DESCRIPTION:${escapeICS(t.t||"Obveza")}`,
      "END:VALARM"
    );
  }

  const ics = lines.join("\r\n");
  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "obveza.ics";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/* =========================
   HELPERS
   ========================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}
function escapeICS(s){
  return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
}

/* INIT */
window.addEventListener("load",()=>{
  const s=localStorage.getItem("lang");
  if(s) lang=s;
  applyLang();
  // quick reminder check on start
  checkReminders();
});
</script>

</body>
</html>
