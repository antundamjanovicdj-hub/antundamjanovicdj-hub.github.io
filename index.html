<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LifeKompas</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ‚úÖ CAVEAT FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest-v2.json?v=2" />
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LifeKompas">
  <meta name="theme-color" content="#0d5e32">

  <link rel="stylesheet" href="styles/main.css">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

<div class="app">

<!-- STANDARD APP HEADER (UX STEP 1.1) -->
<div class="app-header">
  <div class="app-header-left">
    <button class="back" id="headerBack">‚Üê</button>
  </div>

  <div class="app-header-center" id="headerTitle">
    LifeKompas
  </div>

  <div class="app-header-right">
    <!-- DESNA AKCIJA ‚Äì UI ONLY -->
    <button class="header-action hidden" id="headerAction" aria-label="action">
      ‚ûï
    </button>
  </div>
</div>

  <!-- LANGUAGE SCREEN -->
  <div id="screen-lang" class="screen active">
    <div class="lang-title-top">LIFE</div>
    <div class="lang-grid-container">
      <div class="lang-row">
        <button class="lang-btn" data-lang="hr">üá≠üá∑ Hrvatski</button>
        <button class="lang-btn" data-lang="en">üá∫üá∏ English</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="de">üá©üá™ Deutsch</button>
        <button class="lang-btn" data-lang="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="pt">üáµüáπ Portugu√™s</button>
        <button class="lang-btn" data-lang="tr">üáπüá∑ T√ºrk√ße</button>
      </div>
      <div class="lang-row">
  <button class="lang-btn" data-lang="fr">üá´üá∑ Fran√ßais</button>
  <button class="lang-btn" data-lang="es">üá™üá∏ Espa√±ol</button>
</div>
<div class="lang-row">
  <button class="lang-btn" data-lang="it">üáÆüáπ Italiano</button>
  <button class="lang-btn" data-lang="hu">üá≠üá∫ Magyar</button>
</div>
    </div>
    <div class="lang-title-bottom">KOMPAS</div>
  </div>

  <!-- MAIN MENU -->
  <div id="screen-menu" class="screen menu-background">
    <div class="main-menu-buttons">
      <button class="menu-item" id="btnObligations">üß≠ Obveze</button>
      <button class="menu-item" id="btnShopping">üõí Kupovina</button>
      <button class="menu-item" id="btnContacts">üë• Kontakti</button>
      <button class="menu-item" id="btnFinances">üí∞ Financije</button>
      <button class="menu-item" id="btnHealth">‚ù§Ô∏è Zdravlje</button>
      <button class="menu-item" id="btnDiary">üìì Dnevnik</button>
    </div>
  </div>
</div>

<!-- FINANCES MENU SCREEN -->
<div id="screen-finances-menu" class="screen finance-background">
  <h2 class="screen-title">üí∞ Financije</h2>

  <div class="main-menu-buttons">
    <button class="menu-item" id="btnIncomeScreen">üíµ Unos prihoda</button>
    <button class="menu-item" id="btnMonthlyCostsScreen">üìÖ Mjeseƒçni tro≈°kovi</button>
    <button class="menu-item" id="btnCreditsScreen">üè¶ Krediti</button>
    <button class="menu-item" id="btnOtherCostsScreen">üõí Ostali tro≈°kovi</button>
    <button class="menu-item" id="btnCostsOverview">üìä Pregled tro≈°kova</button>
  </div>
</div>
<!-- FINANCE: INCOME SCREEN -->
<div id="screen-finance-income" class="screen finance-background">
  <h2 class="screen-title">üíµ Unos prihoda</h2>

  <div class="finance-form">
    <input type="number" id="incomeAmount" placeholder="Iznos (‚Ç¨)">
    <input type="text" id="incomeDesc" placeholder="Opis (npr. Plaƒáa)">
    <label class="finance-date-label" id="incomeDateLabel">Datum prihoda</label>
<input type="date" id="incomeDate">
    <button id="saveIncome">‚ûï Dodaj prihod</button>
  </div>

  <div id="incomeList" class="finance-list"></div>
</div>


<!-- FINANCE: MONTHLY COSTS SCREEN -->
<div id="screen-finance-fixed" class="screen finance-background">
  <h2 class="screen-title">üìÖ Mjeseƒçni tro≈°kovi</h2>

  <div class="finance-form">
    <input type="text" id="fixedDesc" placeholder="Naziv fiksnog tro≈°ka (npr. Stanarina)">
    <input type="number" id="fixedAmount" placeholder="Iznos (‚Ç¨)">
    <button id="saveFixed">‚ûï Dodaj fiksni tro≈°ak</button>
  </div>

  <div id="fixedList" class="finance-list"></div>
</div>


<!-- FINANCE: CREDITS SCREEN -->
  <div id="screen-finance-credits" class="screen finance-background">
  <h2 class="screen-title">üè¶ Krediti</h2>

  <div class="finance-form">
    <input type="text" id="creditDesc" placeholder="Naziv kredita (npr. Auto kredit)">
    <input type="number" id="creditAmount" placeholder="Iznos rate (‚Ç¨)">

    <label id="creditStartLabel">Poƒçetak kredita</label>
<input type="date" id="creditStart">

<label id="creditEndLabel">Zavr≈°etak kredita</label>
<input type="date" id="creditEnd">

<label id="creditLastPaidLabel">Zadnja uplata</label>
<input type="date" id="creditLastPaid">

    <button id="saveCredit">‚ûï Dodaj kredit</button>
  </div>

  <div id="creditList" class="finance-list"></div>
</div>
<!-- FINANCE: OTHER COSTS SCREEN -->
<div id="screen-finance-other" class="screen finance-background">
  <h2 class="screen-title">üßæ Ostali tro≈°kovi</h2>

  <!-- OTHER COST FORM -->
  <div class="finance-form">
    <input type="text" id="otherDesc" placeholder="Opis tro≈°ka (npr. Gorivo)">
    <input type="number" id="otherAmount" placeholder="Iznos (‚Ç¨)">
    <button id="saveOther">‚ûï Dodaj tro≈°ak</button>
  </div>

  <!-- OTHER COST LIST -->
  <div id="otherList" class="finance-list"></div>
</div>
<!-- FINANCE: COSTS OVERVIEW SCREEN -->
<div id="screen-finance-overview" class="screen finance-background">
  <h2 class="screen-title">üìä Pregled tro≈°kova</h2>

  <div class="finance-form">
  <label id="financeMonthLabel"></label>
  <input type="month" id="financeMonth">
  <button id="btnCalculateMonth">Izraƒçunaj</button>
</div>

  <div id="monthResult" class="finance-list"></div>
</div>

  <!-- SHOPPING SCREEN -->
  <div id="screen-shopping" class="screen">

    <h2 class="screen-title" id="shoppingTitle">üõí Kupovina</h2>

    <div class="shopping-addbar">
      <input
        id="shoppingInput"
        type="text"
        autocomplete="off"
        inputmode="text"
        placeholder="Dodaj stavku i stisni Enter"
      />
    </div>
<button id="btnScanReceipt" class="scan-receipt-btn">
  ‚ûï
</button>

    <button id="toggleArchive" class="archive-toggle">
  Prika≈æi arhivu
</button>

<div id="shoppingSwipeHint" class="swipe-hint hidden">
  ‚Üê Povuci ulijevo za brisanje
</div>

<ul id="shoppingList" class="shopping-list"></ul>

<div id="shoppingEmpty" class="empty-state">
      <div class="empty-emoji">üõí</div>
      <div class="empty-title" id="shoppingEmptyTitle">Nema stavki</div>
      <div class="empty-sub" id="shoppingEmptySub">
        Dodaj prvu stavku gore.
      </div>
    </div>
  </div>

  <!-- POPUP ZA OBVEZE -->
  <div id="obligationsPopup" class="popup-balloon">
    <div class="balloon-content">
      <button class="balloon-btn" id="btnAddObligation">‚ûï Dodaj obvezu</button>
      <button class="balloon-btn" id="btnViewObligations">üìÖ Pregled obveza</button>
    </div>
  </div>

  <!-- EKRAN: DODAVANJE/UREƒêIVANJE OBVEZE -->
  <div id="screen-add-obligation" class="screen">
    <div class="obligation-form">
      <input type="text" id="obligationTitle" placeholder="Naslov obveze" maxlength="100">
      <textarea id="obligationNote" placeholder="Napomena" rows="3"></textarea>

      <label class="datetime-label">
        <span id="obligationDateTimeLabel">Datum i vrijeme</span>
        <input type="datetime-local" id="obligationDateTime">
      </label>

      <label class="reminder-checkbox">
        <input type="checkbox" id="enableReminder">
        <span id="reminderLabel">Podsjetnik</span>
      </label>
      <label class="reminder-checkbox">
        <input type="checkbox" id="urgentObligation">
        <span id="urgentLabel"></span>
     </label>

      <div id="reminderOptions" class="hidden">
        <select id="reminderTime">
  <option value="30"></option>
  <option value="60"></option>
  <option value="120"></option>
  <option value="1440"></option>
</select>
      </div>
<label class="repeat-label">
  <span id="repeatLabel"></span>
  <select id="repeatType">
    <option value=""></option>
    <option value="daily"></option>
    <option value="weekly"></option>
  </select>
</label>
<label class="quiet-hours-label">
  <span id="quietHoursLabel"></span>
  <div class="quiet-hours-row">
    <input type="time" id="quietStart" value="22:00">
    <span>‚Äì</span>
    <input type="time" id="quietEnd" value="07:00">
  </div>
</label>

      <button id="saveObligation" class="btn-save">üíæ Spremi</button>
      <button id="cancelObligation" class="btn-cancel"></button>
    </div>
  </div>

  <!-- EKRAN: PREGLED OBVEZA -->
  <div id="screen-obligations-list" class="screen">
  <div class="calm-surface">

    <!-- TOOLBAR -->
    <div class="obligations-toolbar">
      <button id="btnViewByDays" class="toolbar-btn">
        üìÜ Pregled po danima
      </button>
    </div>

    <!-- DATE PICKER ‚Äì samo za daily view -->
    <div id="dailyDateBar" class="hidden" style="padding: 8px 12px;">
      <input
        type="date"
        id="dailyDatePicker"
        style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.15);"
      >
    </div>

    <!-- LIST VIEW -->
    <div id="obligationsContainer" class="obligations-list"></div>

    <!-- DAILY VIEW -->
    <div id="dailyView" class="hidden" style="padding: 0 12px 16px;">
      <div id="dailyOpenWrap"></div>
      <div id="dailyDoneWrap"></div>
    </div>
  </div> <!-- calm-surface -->
</div> <!-- /screen-obligations-list -->

<!-- CONTACT FORM SCREEN -->
<div id="screen-contact-form" class="screen">

  <h2 class="screen-title" id="contactFormTitle">
    <img src="images/contacts-icon.png" class="contacts-title-icon">
    Novi kontakt
  </h2>

  <div class="contact-form">

    <input type="text" id="contactFirstName" placeholder="">
    <input type="text" id="contactLastName" placeholder="">
    <input type="text" id="contactBirthDate" placeholder="">

    <label class="contact-form-label" id="contactBirthdayTimeLabel"></label>
    <input type="time" id="contactBirthdayTime">

    <input type="text" id="contactAddress" placeholder="">
    <input type="email" id="contactEmail" placeholder="">
    <input type="tel" id="contactPhone" placeholder="">

    <!-- PHOTO PICKER -->
    <button id="btnPickContactPhoto"></button>
    <input type="hidden" id="contactPhotoData">

    <button id="saveContact"></button>

  </div>
</div>

<!-- CONTACT DETAILS SCREEN -->
<div id="screen-contact-details" class="screen finance-background">

  <h2 class="screen-title" id="contactDetailsTitle">üë§ Kontakt</h2>

  <div class="calm-surface">
    <div id="contactDetailsContent" class="contact-details"></div>
</div>

  <!-- ACTION BUTTONS -->
  <div class="contact-details-actions">
    <button id="btnEditContact"></button>
    <button id="btnDeleteContact"></button>
  </div>
</div>

</div> <!-- .app -->

<!-- CONTACTS SCREEN -->
<div id="screen-contacts" class="screen">

  <!-- ACTION BUTTONS -->
<div class="contacts-actions">
  <button id="btnImportContacts"
          class="menu-item"
          onclick="importDeviceContacts()">
    üì• Uvezi iz imenika
  </button>
</div>

  <!-- SEARCH -->
  <div class="contacts-search">
    <input type="text" id="searchContacts" placeholder="Search...">
  </div>

  <!-- LIST -->
  <div id="contactsList" class="contacts-list"></div>
</div>

<!-- APP VERSION -->
<div id="appVersion" style="
  position: fixed;
  bottom: 4px;
  right: 8px;
  font-size: 11px;
  opacity: 0.6;
  pointer-events: none;
"></div>

<!-- SKRIPTOVE -->
<script src="core/i18n.js"></script>
<script type="module" src="core/db.js"></script>
<script type="module" src="core/contacts.js"></script>
<script type="module" src="core/app-init-main.js"></script>
<script type="module" src="core/app-init.js"></script>

<script type="module">
import {
  todayISO,
  getISODateFromDateTime,
  getLang
} from './core/app-init.js';

window.todayISO = todayISO;
window.getISODateFromDateTime = getISODateFromDateTime;
window.getLang = getLang;

// ===== PRE-BOOT CRASH GUARD =====

const BOOT_FAIL_KEY = 'lifekompas_boot_fail';
const bootFails = Number(localStorage.getItem(BOOT_FAIL_KEY) || 0);

// ako je app pukao 3x pri startu ‚Üí safe mode
if (bootFails >= 3) {

  document.body.style.background = '#0d5e32';

  document.body.innerHTML = `
    <div style="
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      font-family:sans-serif;
      text-align:center;
      padding:24px;
      color:white;
    ">
      <h2>LifeKompas Safe Mode</h2>
      <p>Aplikacija se ru≈°ila pri pokretanju.</p>

      <button onclick="
        localStorage.removeItem('${BOOT_FAIL_KEY}');
        location.reload();
      " style="
        padding:14px 22px;
        border:none;
        border-radius:14px;
        font-size:16px;
      ">
        Pokreni ponovo
      </button>
    </div>
  `;

  throw new Error("BOOT BLOCKED");
}

// poveƒáaj counter ‚Äî resetiramo ga kad app boot-a
localStorage.setItem(BOOT_FAIL_KEY, bootFails + 1);

// ===== LIFE KOMPAS CRASH SHIELD (PRO) =====

(function () {

  function saveCrash(type, err) {
    try {
      localStorage.setItem(
        'lifekompas_last_crash',
        JSON.stringify({
          type,
          message: err?.message || String(err),
          stack: err?.stack || null,
          time: new Date().toISOString()
        })
      );
    } catch {}
  }

  function showCrashScreen() {

    document.body.innerHTML = '';
    document.body.style.background = '#0d5e32';
    document.body.insertAdjacentHTML('afterbegin', `
      <div style="
        height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        flex-direction:column;
        font-family:sans-serif;
        text-align:center;
        padding:24px;
        background:#0d5e32;
        color:white;
      ">
        <h2>LifeKompas</h2>
        <p>Aplikacija je nai≈°la na neoƒçekivanu gre≈°ku.</p>
        <button onclick="location.reload()" style="
          padding:14px 22px;
          border:none;
          border-radius:14px;
          font-size:16px;
          cursor:pointer;
        ">
          Ponovno pokreni
        </button>
      </div>
    `);
  }

  window.addEventListener('error', (event) => {
    console.error('GLOBAL ERROR:', event.error || event.message);
    saveCrash('error', event.error || event.message);
    showCrashScreen();
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('UNHANDLED PROMISE:', event.reason);
    saveCrash('promise', event.reason);
    showCrashScreen();
  });

})();

/* ===== SET LANGUAGE + SHOW MENU ===== */
function setLanguage(lang) {
  localStorage.setItem('userLang', lang);
  document.documentElement.setAttribute('lang', lang);

  if (typeof I18N === 'undefined' || !I18N[lang]) {
    showScreen('screen-menu');
    return;
  }
// ===== LANGUAGE FALLBACK TO ENGLISH =====
  if (!I18N[lang].obligationsView) I18N[lang].obligationsView = I18N.en.obligationsView;
  if (!I18N[lang].obligationsList) I18N[lang].obligationsList = I18N.en.obligationsList;
  if (!I18N[lang].obligation) I18N[lang].obligation = I18N.en.obligation;
  if (!I18N[lang].popup) I18N[lang].popup = I18N.en.popup;
  if (!I18N[lang].shopping) I18N[lang].shopping = I18N.en.shopping;
  if (!I18N[lang].finances) I18N[lang].finances = I18N.en.finances;

  document.getElementById('btnObligations').textContent = I18N[lang].menu.obligations;
  document.getElementById('btnShopping').textContent = I18N[lang].menu.shopping;
  document.getElementById('btnContacts').textContent = I18N[lang].menu.contacts;
  document.getElementById('btnFinances').textContent = I18N[lang].menu.finances;
  document.getElementById('btnHealth').textContent = I18N[lang].menu.health;
  document.getElementById('btnDiary').textContent = I18N[lang].menu.diary;
// ===== CONTACTS SCREEN TEXT =====
  const c = I18N[lang].contacts || I18N.en.contacts;

  // Title (ikona ostaje, mijenja se samo tekst)
  const contactsTitle = document.getElementById('contactsTitle');
  if (contactsTitle && c) {
    contactsTitle.innerHTML = `<img src="images/contacts-icon.png" class="contacts-title-icon"> ${c.title}`;
  }

  // Import button
  const btnImport = document.getElementById('btnImportContacts');
  if (btnImport && c) {
    btnImport.textContent = c.import;
  }

  // Add button
  const btnAddContact = document.getElementById('btnAddContact');
  if (btnAddContact && c) {
    btnAddContact.textContent = c.add;
  }

  // Search placeholder
  const searchContacts = document.getElementById('searchContacts');
  if (searchContacts && c) {
    searchContacts.placeholder = c.search;
  }

// ===== CONTACT FORM TEXT =====
const cf =
  (I18N[lang].contacts && I18N[lang].contacts.form)
    ? I18N[lang].contacts.form
    : (I18N.en.contacts && I18N.en.contacts.form)
        ? I18N.en.contacts.form
        : {
            title: "",
            firstName: "",
            lastName: "",
            birthDate: "",
            birthdayTime: "",
            address: "",
            email: "",
            phone: "",
            pickPhoto: "",
            save: ""
          };

// ===== CONTACT DETAILS TEXT =====
const cd =
  (I18N[lang].contacts && I18N[lang].contacts.details)
    ? I18N[lang].contacts.details
    : (I18N.en.contacts && I18N.en.contacts.details)
        ? I18N.en.contacts.details
        : {
            title: "",
            edit: "",
            delete: "",
            birthdayNotify: ""
          };

// Birthday notify label inside details
const cdBirthdayNotifyText = document.getElementById('cdBirthdayNotifyText');
if (cdBirthdayNotifyText) cdBirthdayNotifyText.textContent = cd.birthdayNotify;

// Title
const contactDetailsTitle = document.getElementById('contactDetailsTitle');
if (contactDetailsTitle) contactDetailsTitle.textContent = cd.title;

// Buttons
const btnEditContact = document.getElementById('btnEditContact');
if (btnEditContact) btnEditContact.textContent = "‚úèÔ∏è " + cd.edit;

const btnDeleteContact = document.getElementById('btnDeleteContact');
if (btnDeleteContact) btnDeleteContact.textContent = "üóëÔ∏è " + cd.delete;

// Title
const contactFormTitle = document.getElementById('contactFormTitle');
if (contactFormTitle) {
  contactFormTitle.innerHTML = `<img src="images/contacts-icon.png" class="contacts-title-icon"> ${cf.title}`;
}

// Placeholders
const cfFirst = document.getElementById('contactFirstName');
const cfLast = document.getElementById('contactLastName');
const cfBirth = document.getElementById('contactBirthDate');
const cfAddress = document.getElementById('contactAddress');
const cfEmail = document.getElementById('contactEmail');
const cfPhone = document.getElementById('contactPhone');

if (cfFirst) cfFirst.placeholder = cf.firstName;
if (cfLast) cfLast.placeholder = cf.lastName;
if (cfBirth) cfBirth.placeholder = cf.birthDate;
if (cfAddress) cfAddress.placeholder = cf.address;
if (cfEmail) cfEmail.placeholder = cf.email;
if (cfPhone) cfPhone.placeholder = cf.phone;

// Birthday time label
const cfTimeLabel = document.getElementById('contactBirthdayTimeLabel');
if (cfTimeLabel) cfTimeLabel.textContent = cf.birthdayTime;

// Buttons
const cfPickPhoto = document.getElementById('btnPickContactPhoto');
if (cfPickPhoto) cfPickPhoto.textContent = "üñºÔ∏è " + cf.pickPhoto;

const cfSave = document.getElementById('saveContact');
if (cfSave) cfSave.textContent = "üíæ " + cf.save;


  // ===== FINANCES MENU + SCREENS (guarded) =====
  if (I18N[lang].finances) {
// --- FINANCES MENU TITLE ---
    const finTitle = document.querySelector('#screen-finances-menu h2');
    if (finTitle) finTitle.textContent = I18N[lang].menu.finances;

    // --- FINANCES MENU ---
    document.getElementById('btnIncomeScreen').textContent = I18N[lang].finances.menu.income;
    document.getElementById('btnMonthlyCostsScreen').textContent = I18N[lang].finances.menu.fixed;
    document.getElementById('btnCreditsScreen').textContent = I18N[lang].finances.menu.credits;
    document.getElementById('btnOtherCostsScreen').textContent = I18N[lang].finances.menu.other;
    document.getElementById('btnCostsOverview').textContent = I18N[lang].finances.menu.overview;

    // --- FINANCE SCREEN TITLES ---
    document.querySelector('#screen-finance-income h2').textContent = I18N[lang].finances.income.title;
    document.querySelector('#screen-finance-fixed h2').textContent = I18N[lang].finances.fixed.title;
    document.querySelector('#screen-finance-credits h2').textContent = I18N[lang].finances.credits.title;
    document.querySelector('#screen-finance-other h2').textContent = I18N[lang].finances.other.title;
    document.querySelector('#screen-finance-overview h2').textContent = I18N[lang].finances.overview.title;

// --- FINANCE INCOME PLACEHOLDERS ---
    const incAmount = document.getElementById('incomeAmount');
    const incDesc = document.getElementById('incomeDesc');
    if (incAmount) incAmount.placeholder = I18N[lang].finances.income.amountPh;
    if (incDesc) incDesc.placeholder = I18N[lang].finances.income.descPh;
    const incomeDateLabel = document.getElementById('incomeDateLabel');
    if (incomeDateLabel) incomeDateLabel.textContent = I18N[lang].finances.income.dateLabel;

// --- FINANCE FIXED PLACEHOLDERS ---
    const fixedDesc = document.getElementById('fixedDesc');
    const fixedAmount = document.getElementById('fixedAmount');
    if (fixedDesc) fixedDesc.placeholder = I18N[lang].finances.fixed.descPh;
    if (fixedAmount) fixedAmount.placeholder = I18N[lang].finances.fixed.amountPh;

 // --- FINANCE CREDITS PLACEHOLDERS ---
    const creditDesc = document.getElementById('creditDesc');
    const creditAmount = document.getElementById('creditAmount');
    if (creditDesc) creditDesc.placeholder = I18N[lang].finances.credits.descPh;
    if (creditAmount) creditAmount.placeholder = I18N[lang].finances.credits.amountPh;

// --- FINANCE CREDITS LABELS ---
    const creditStartLabel = document.getElementById('creditStartLabel');
    const creditEndLabel = document.getElementById('creditEndLabel');
    const creditLastPaidLabel = document.getElementById('creditLastPaidLabel');

    if (creditStartLabel) creditStartLabel.textContent = I18N[lang].finances.credits.startLabel;
    if (creditEndLabel) creditEndLabel.textContent = I18N[lang].finances.credits.endLabel;
    if (creditLastPaidLabel) creditLastPaidLabel.textContent = I18N[lang].finances.credits.lastPaidLabel;

// --- FINANCE OTHER COSTS PLACEHOLDERS ---
    const otherDesc = document.getElementById('otherDesc');
    const otherAmount = document.getElementById('otherAmount');
    if (otherDesc) otherDesc.placeholder = I18N[lang].finances.other.descPh;
    if (otherAmount) otherAmount.placeholder = I18N[lang].finances.other.amountPh;

    // --- FINANCE BUTTONS ---
    document.getElementById('saveIncome').textContent = "‚ûï " + I18N[lang].finances.income.add;
    document.getElementById('saveFixed').textContent = "‚ûï " + I18N[lang].finances.fixed.add;
    document.getElementById('saveCredit').textContent = "‚ûï " + I18N[lang].finances.credits.add;
    document.getElementById('saveOther').textContent = "‚ûï " + I18N[lang].finances.other.add;
    document.getElementById('btnCalculateMonth').textContent = I18N[lang].finances.overview.calculate;
    const monthLabel = document.getElementById('financeMonthLabel');
if (monthLabel) monthLabel.textContent = I18N[lang].obligationsView.selectDate || I18N.en.obligationsView.selectDate;
  }

 // ===== REFRESH CONTACTS TRANSLATION IF SCREEN ALREADY OPEN =====
  const currentContactsScreen = document.getElementById('screen-contacts');
  if (currentContactsScreen && currentContactsScreen.classList.contains('active')) {
    const c = I18N[lang].contacts || I18N.en.contacts;

    const contactsTitle = document.getElementById('contactsTitle');
    if (contactsTitle && c) {
      contactsTitle.innerHTML = `<img src="images/contacts-icon.png" class="contacts-title-icon"> ${c.title}`;
    }

    const btnImport = document.getElementById('btnImportContacts');
    if (btnImport && c) btnImport.textContent = c.import;

    const btnAddContact = document.getElementById('btnAddContact');
    if (btnAddContact && c) btnAddContact.textContent = c.add;

    const searchContacts = document.getElementById('searchContacts');
    if (searchContacts && c) searchContacts.placeholder = c.search;
  }
  showScreen('screen-menu');

// UX 1.6 ‚Äì reset history nakon izbora jezika
screenHistory.length = 0;

  setTimeout(() => {
    document.querySelectorAll('.menu-item').forEach((item, i) => {
      setTimeout(() => item.classList.add('animate'), 150 * i);
    });
  }, 50);
}

/* ===== OTVORI FORMU ZA UREƒêIVANJE ===== */
function openEditForm(ob) {
  showScreen('screen-add-obligation');
// ‚úÖ ensure i18n on edit as well
  requestAnimationFrame(() => {
    applyAddObligationI18N();
  });

  const lang = document.documentElement.getAttribute('lang') || getLang();

  document.getElementById('obligationTitle').value = ob.title;
  document.getElementById('obligationNote').value = ob.note || '';
  document.getElementById('obligationDateTime').value = ob.dateTime || '';
  document.getElementById('enableReminder').checked = !!ob.reminder;
  const urgentCheckbox = document.getElementById('urgentObligation');
if (urgentCheckbox) {
  urgentCheckbox.checked = !!ob.urgent;
}
  document.getElementById('reminderOptions').classList.toggle('hidden', !ob.reminder);
const reminderSelect = document.getElementById('reminderTime');
reminderSelect.querySelector('option[value="30"]').textContent = I18N[lang].obligationsList.reminder30;
reminderSelect.querySelector('option[value="60"]').textContent = I18N[lang].obligationsList.reminder60;
reminderSelect.querySelector('option[value="120"]').textContent = I18N[lang].obligationsList.reminder120;
reminderSelect.querySelector('option[value="1440"]').textContent = I18N[lang].obligationsList.reminder1440;
  document.getElementById('urgentLabel').textContent = I18N[lang].obligation.urgent;
  if (ob.reminder) document.getElementById('reminderTime').value = ob.reminder;

  document.getElementById('saveObligation').textContent = I18N[lang].obligation.update;
  document.getElementById('saveObligation').dataset.editId = ob.id;
  document.getElementById('cancelObligation').textContent = `‚úñÔ∏è ${I18N[lang].obligation.cancel}`;
const repeatSelect = document.getElementById('repeatType');
if (repeatSelect) {
  repeatSelect.value = ob.repeat || '';

  document.getElementById('repeatLabel').textContent = I18N[lang].obligation.repeat;

  repeatSelect.querySelector('option[value=""]').textContent = I18N[lang].obligation.repeatNone;
  repeatSelect.querySelector('option[value="daily"]').textContent = I18N[lang].obligation.repeatDaily;
  repeatSelect.querySelector('option[value="weekly"]').textContent =
  I18N[lang].obligation.repeatWeekly;
 }
}

// ===== APPLY I18N: ADD / EDIT OBLIGATION =====
function applyAddObligationI18N() {
  const lang = getLang();

  document.getElementById('obligationTitle').placeholder =
    I18N[lang].obligation.title;

  document.getElementById('obligationNote').placeholder =
    I18N[lang].obligation.note;

  document.getElementById('obligationDateTimeLabel').textContent =
    I18N[lang].obligation.dateTime;

  document.getElementById('reminderLabel').textContent =
    I18N[lang].obligation.reminder;

  document.getElementById('urgentLabel').textContent =
    I18N[lang].obligation.urgent;

  document.getElementById('quietHoursLabel').textContent =
    I18N[lang].obligation.quietHours;

  document.getElementById('repeatLabel').textContent =
    I18N[lang].obligation.repeat;

  const repeatSelect = document.getElementById('repeatType');
  repeatSelect.querySelector('option[value=""]').textContent =
    I18N[lang].obligation.repeatNone;
  repeatSelect.querySelector('option[value="daily"]').textContent =
    I18N[lang].obligation.repeatDaily;
  repeatSelect.querySelector('option[value="weekly"]').textContent =
    I18N[lang].obligation.repeatWeekly;

  const reminderSelect = document.getElementById('reminderTime');
  reminderSelect.querySelector('option[value="30"]').textContent =
    I18N[lang].obligationsList.reminder30;
  reminderSelect.querySelector('option[value="60"]').textContent =
    I18N[lang].obligationsList.reminder60;
  reminderSelect.querySelector('option[value="120"]').textContent =
    I18N[lang].obligationsList.reminder120;
  reminderSelect.querySelector('option[value="1440"]').textContent =
    I18N[lang].obligationsList.reminder1440;

  document.getElementById('saveObligation').textContent =
    I18N[lang].obligation.save;

  document.getElementById('cancelObligation').textContent =
    `‚úñÔ∏è ${I18N[lang].obligation.cancel}`;
}

/* ===== RENDER CARD (reused) ===== */
function buildObligationCard(ob, lang) {
  // ===== NORMALIZE OB OBJECT (prevent "undefined") =====
  const safe = {
    id: ob.id,
    title: ob.title || '',
    note: ob.note || '',
    dateTime: ob.dateTime || null,
    reminder: ob.reminder || null,
    repeat: ob.repeat || null,
    status: ob.status || 'active'
  };

  const t = (window.I18N && I18N[lang]) ? I18N[lang] : I18N.hr;
  const ol = (t && t.obligationsList) ? t.obligationsList : I18N.hr.obligationsList;

  const dt = safe.dateTime ? new Date(safe.dateTime) : null;
  const dateStr = dt ? dt.toLocaleDateString((t && t.lang) || 'hr-HR') : '‚Äî';
  const timeStr = dt ? dt.toLocaleTimeString((t && t.lang) || 'hr-HR', { hour: '2-digit', minute: '2-digit' }) : '‚Äî';
  const isOverdue =
  safe.dateTime &&
  getISODateFromDateTime(safe.dateTime) < todayISO();

  const overdueHint = isOverdue
  ? `<div style="font-size:12px; opacity:0.6; margin-top:2px;">Zaka≈°njelo</div>`
  : '';

  let reminderStr = '';
  if (safe.reminder) {
    const key = `reminder${safe.reminder}`;
    reminderStr = (ol && ol[key]) ? ol[key] : `${safe.reminder} min`;
  }

  let repeatIcon = '';
  let repeatTitle = '';

  if (safe.repeat) {
    repeatIcon = ' üîÅ';
    if (safe.repeat === 'daily') repeatTitle = (t.obligation?.repeatDaily || 'Daily');
    else if (safe.repeat === 'weekly') repeatTitle = (t.obligation?.repeatWeekly || 'Weekly');
    else repeatTitle = '';
  }

  const statusDoneText = ol.statusDone || 'Done';
  const statusActiveText = ol.statusActive || 'Active';

  const statusText = safe.status === 'done'
    ? `‚úÖ ${statusDoneText}`
    : `‚è≥ ${statusActiveText}`;

const bgColor = safe.status === 'done'
  ? '#e8f5e9'
  : isOverdue
    ? '#f7f7f7'
    : '#e3f2fd';

const borderColor = safe.status === 'done'
  ? '#4caf50'
  : isOverdue
    ? '#bbb'
    : '#2196f3';

  const toggleBtnText = safe.status === 'done'
    ? (ol.markActive || '‚è≥ Active')
    : (ol.markDone || '‚úÖ Done');

  const editText = ol.edit || 'Edit';
  const deleteText = ol.delete || 'Delete';

  return `
    <div class="obligation-card" data-id="${safe.id}" style="background:${bgColor}; border-left:4px solid ${borderColor};">
      <div class="obligation-title" title="${repeatTitle}">${safe.title}${repeatIcon}</div>

      ${safe.note ? `<div class="obligation-note">${safe.note}</div>` : ''}

      <div class="obligation-meta">
        <div class="obligation-date">
  üìÖ ${dateStr}
  ${overdueHint}
</div>
<div class="obligation-time">‚è∞ ${timeStr}</div>
        ${reminderStr ? `<div class="obligation-reminder">üîî ${reminderStr}</div>` : ''}
        <div class="obligation-status">${statusText}</div>
      </div>

      <button class="obligation-toggle-status" data-id="${safe.id}" data-status="${safe.status}">
        ${toggleBtnText}
      </button>

      <button class="obligation-edit" data-id="${safe.id}">‚úèÔ∏è ${editText}</button>

      <button
        class="obligation-delete"
        data-id="${safe.id}"
        title="${deleteText}"
        aria-label="${deleteText}"
      >
        üóëÔ∏è
      </button>
    </div>
  `;
}

function attachObligationHandlers(container) {
  // PROMJENA STATUSA
  container.querySelectorAll('.obligation-toggle-status').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const currentStatus = btn.dataset.status;
      const newStatus = currentStatus === 'done' ? 'active' : 'done';

      const obligations = await obligationDB.getAll();
      const obligation = obligations.find(o => o.id === id);
      if (!obligation) return;

      obligation.status = newStatus;
await obligationDB.add(obligation);

if (newStatus === 'done') {
  import('./core/notifications.js').then(async ({
    cancelObligationNotification,
    scheduleObligationNotification
  }) => {
    cancelObligationNotification(id);

    if (
  obligation.repeat &&
  obligation.dateTime &&
  !obligation.repeatPaused
) {
if (obligation.skipNextRepeat) {
  obligation.skipNextRepeat = false;
  await obligationDB.add(obligation);
  return;
}
      const baseDate = new Date(obligation.dateTime);
      const nextDate = new Date(baseDate);
if (obligation.repeat === 'custom' && obligation.customRepeat) {
  const { unit, every } = obligation.customRepeat;
  const baseDate = new Date(obligation.dateTime);
  const nextDate = new Date(baseDate);

  if (unit === 'day') nextDate.setDate(baseDate.getDate() + every);
  if (unit === 'week') nextDate.setDate(baseDate.getDate() + every * 7);
  if (unit === 'month') nextDate.setMonth(baseDate.getMonth() + every);

  const nextObligation = {
    ...obligation,
    id: Date.now(),
    status: 'active',
    dateTime: nextDate.toISOString().slice(0, 16),
    createdAt: new Date().toISOString()
  };

  await obligationDB.add(nextObligation);
  await scheduleObligationNotification(nextObligation);
  return;
}

      if (obligation.repeat === 'daily') {
  nextDate.setDate(baseDate.getDate() + 1);
}

if (obligation.repeat === 'weekly') {
  nextDate.setDate(baseDate.getDate() + 7);
}

if (obligation.repeat === 'monthly') {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth() + 1; // next month
  const day = baseDate.getDate();

  // zadnji dan ciljanog mjeseca
  const lastDayOfTargetMonth = new Date(year, month + 1, 0).getDate();

  nextDate.setFullYear(year);
  nextDate.setMonth(month);
  nextDate.setDate(Math.min(day, lastDayOfTargetMonth));
}

      const nextObligation = {
        ...obligation,
        id: Date.now(),
        status: 'active',
        dateTime: nextDate.toISOString().slice(0, 16),
        createdAt: new Date().toISOString()
      };

      await obligationDB.add(nextObligation);
      await scheduleObligationNotification(nextObligation);
    }
  });
}

refreshCurrentObligationsView();
    });
  });

  // UREƒêIVANJE
  container.querySelectorAll('.obligation-edit').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const obligations = await obligationDB.getAll();
      const ob = obligations.find(o => o.id === id);
      if (ob) openEditForm(ob);
    });
  });

  // BRISANJE
  container.querySelectorAll('.obligation-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const langNow = getLang();

      if (!confirm(I18N[langNow].obligationsList.deleteConfirm || 'Obrisati obvezu?')) {
        return;
      }

      await obligationDB.delete(id);

      import('./core/notifications.js').then(({ cancelObligationNotification }) => {
        cancelObligationNotification(id);
      });

      refreshCurrentObligationsView();
    });
  });
}

/* ===== LIST VIEW RENDER ===== */
async function renderObligationsList() {
  if (viewMode === 'days') return;

  const container = document.getElementById('obligationsContainer');
  const lang = getLang();

  const today = todayISO();

const obligations = (await obligationDB.getAll())
  .filter(o =>
    o.type !== 'shopping' &&
    o.status !== 'done' &&
    o.dateTime &&
    getISODateFromDateTime(o.dateTime) <= today
  );

  obligations.sort((a, b) => {
    if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
    if (!a.dateTime) return 1;
    if (!b.dateTime) return -1;
    return new Date(b.dateTime) - new Date(a.dateTime);
  });

const todayItems = obligations.filter(o =>
  getISODateFromDateTime(o.dateTime) === today
);

const overdueItems = obligations.filter(o =>
  getISODateFromDateTime(o.dateTime) < today
);

if (todayItems.length === 0 && overdueItems.length === 0) {
  container.innerHTML = `
    <div class="empty-list">
      <div style="font-size:26px; margin-bottom:8px;">üå±</div>

      <div style="font-weight:800; font-size:16px;">
        ${I18N[lang].obligationsList.noObligations}
      </div>

      <div style="opacity:0.7; font-size:14px; margin-top:6px;">
        Nema obveza za danas. Sve je mirno i pod kontrolom.
      </div>

      <div style="margin-top:14px; font-size:14px; opacity:0.85;">
        ‚ûï Dodaj novu obvezu kad bude≈° spreman.
      </div>
    </div>
  `;
  return;
}

let html = '';

const todayDate = new Date().toLocaleDateString(
  (I18N[lang] && I18N[lang].lang) || 'hr-HR',
  { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }
);

html += `
  <div class="obligations-date">
    Danas ¬∑ ${todayDate}
  </div>
`;

if (todayItems.length > 0) {
  html += `
    <div class="obligations-section-title">Danas</div>
    ${todayItems.map(ob => buildObligationCard(ob, lang)).join('')}
  `;
}

if (overdueItems.length > 0) {
  html += `
    <div class="obligations-section-title overdue">
  Zaka≈°njelo
</div>
    ${overdueItems.map(ob => buildObligationCard(ob, lang)).join('')}
  `;
}

container.innerHTML = html;
attachObligationHandlers(container);
}

/* ===== SHOPPING (IndexedDB + Archive) ===== */
/* ===== INIT ===== */
/* ===== LANGUAGE BUTTON ENGINE ===== */
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.lang;
      if (!lang) return;

      setLanguage(lang);
    });
  });

});
</script>

</body>
</html>