<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LifeKompas</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- âœ… CAVEAT FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest-v2.json?v=2" />
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LifeKompas">
  <meta name="theme-color" content="#0d5e32">

  <link rel="stylesheet" href="styles/main.css">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>

<div class="app">

  <!-- LANGUAGE SCREEN -->
  <div id="screen-lang" class="screen active">
    <div class="lang-title-top">LIFE</div>
    <div class="lang-grid-container">
      <div class="lang-row">
        <button class="lang-btn" data-lang="hr">ğŸ‡­ğŸ‡· Hrvatski</button>
        <button class="lang-btn" data-lang="en">ğŸ‡ºğŸ‡¸ English</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="de">ğŸ‡©ğŸ‡ª Deutsch</button>
        <button class="lang-btn" data-lang="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</button>
        <button class="lang-btn" data-lang="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
      </div>
    </div>
    <div class="lang-title-bottom">KOMPAS</div>
  </div>

  <!-- MAIN MENU -->
  <div id="screen-menu" class="screen menu-background">
    <button class="back" id="backMenu">â†</button>
    <div class="main-menu-buttons">
      <button class="menu-item" id="btnObligations">ğŸ§­ Obveze</button>
      <button class="menu-item" id="btnShopping">ğŸ›’ Kupovina</button>
      <button class="menu-item" id="btnContacts">ğŸ‘¥ Kontakti</button>
      <button class="menu-item" id="btnFinances">ğŸ’° Financije</button>
      <button class="menu-item" id="btnHealth">â¤ï¸ Zdravlje</button>
      <button class="menu-item" id="btnDiary">ğŸ““ Dnevnik</button>
    </div>
  </div>
</div>

<!-- FINANCES MENU SCREEN -->
<div id="screen-finances-menu" class="screen menu-background">
  <button class="back" id="backFinancesMenu">â†</button>
  <h2 class="screen-title">ğŸ’° Financije</h2>

  <div class="main-menu-buttons">
    <button class="menu-item" id="btnIncomeScreen">ğŸ’µ Unos prihoda</button>
    <button class="menu-item" id="btnMonthlyCostsScreen">ğŸ“… MjeseÄni troÅ¡kovi</button>
    <button class="menu-item" id="btnCreditsScreen">ğŸ¦ Krediti</button>
    <button class="menu-item" id="btnOtherCostsScreen">ğŸ›’ Ostali troÅ¡kovi</button>
    <button class="menu-item" id="btnCostsOverview">ğŸ“Š Pregled troÅ¡kova</button>
  </div>
</div>
<!-- FINANCE: INCOME SCREEN -->
<div id="screen-finance-income" class="screen menu-background">
  <button class="back" id="backFinanceIncome">â†</button>
  <h2 class="screen-title">ğŸ’µ Unos prihoda</h2>

  <div class="finance-form">
    <input type="number" id="incomeAmount" placeholder="Iznos (â‚¬)">
    <input type="text" id="incomeDesc" placeholder="Opis (npr. PlaÄ‡a)">
    <label class="finance-date-label" id="incomeDateLabel">Datum prihoda</label>
<input type="date" id="incomeDate">
    <button id="saveIncome">â• Dodaj prihod</button>
  </div>

  <div id="incomeList" class="finance-list"></div>
</div>


<!-- FINANCE: MONTHLY COSTS SCREEN -->
<div id="screen-finance-fixed" class="screen menu-background">
  <button class="back" id="backFinanceFixed">â†</button>
  <h2 class="screen-title">ğŸ“… MjeseÄni troÅ¡kovi</h2>

  <div class="finance-form">
    <input type="text" id="fixedDesc" placeholder="Naziv fiksnog troÅ¡ka (npr. Stanarina)">
    <input type="number" id="fixedAmount" placeholder="Iznos (â‚¬)">
    <button id="saveFixed">â• Dodaj fiksni troÅ¡ak</button>
  </div>

  <div id="fixedList" class="finance-list"></div>
</div>


<!-- FINANCE: CREDITS SCREEN -->
<<div id="screen-finance-credits" class="screen menu-background">
  <button class="back" id="backFinanceCredits">â†</button>
  <h2 class="screen-title">ğŸ¦ Krediti</h2>

  <div class="finance-form">
    <input type="text" id="creditDesc" placeholder="Naziv kredita (npr. Auto kredit)">
    <input type="number" id="creditAmount" placeholder="Iznos rate (â‚¬)">

    <label id="creditStartLabel">PoÄetak kredita</label>
<input type="date" id="creditStart">

<label id="creditEndLabel">ZavrÅ¡etak kredita</label>
<input type="date" id="creditEnd">

<label id="creditLastPaidLabel">Zadnja uplata</label>
<input type="date" id="creditLastPaid">

    <button id="saveCredit">â• Dodaj kredit</button>
  </div>

  <div id="creditList" class="finance-list"></div>
</div>
<!-- FINANCE: OTHER COSTS SCREEN -->
<div id="screen-finance-other" class="screen menu-background">
  <button class="back" id="backFinanceOther">â†</button>
  <h2 class="screen-title">ğŸ§¾ Ostali troÅ¡kovi</h2>

  <!-- OTHER COST FORM -->
  <div class="finance-form">
    <input type="text" id="otherDesc" placeholder="Opis troÅ¡ka (npr. Gorivo)">
    <input type="number" id="otherAmount" placeholder="Iznos (â‚¬)">
    <button id="saveOther">â• Dodaj troÅ¡ak</button>
  </div>

  <!-- OTHER COST LIST -->
  <div id="otherList" class="finance-list"></div>
</div>
<!-- FINANCE: COSTS OVERVIEW SCREEN -->
<div id="screen-finance-overview" class="screen menu-background">
  <button class="back" id="backFinanceOverview">â†</button>
  <h2 class="screen-title">ğŸ“Š Pregled troÅ¡kova</h2>

  <div class="finance-form">
    <label>Odaberi mjesec</label>
    <input type="month" id="financeMonth">
    <button id="btnCalculateMonth">IzraÄunaj</button>
  </div>

  <div id="monthResult" class="finance-list"></div>
</div>

  <!-- SHOPPING SCREEN -->
  <div id="screen-shopping" class="screen">
    <button class="back" id="backShopping">â†</button>

    <h2 class="screen-title" id="shoppingTitle">ğŸ›’ Kupovina</h2>

    <div class="shopping-addbar">
      <input
        id="shoppingInput"
        type="text"
        autocomplete="off"
        inputmode="text"
        placeholder="Dodaj stavku i stisni Enter"
      />
    </div>
<button id="btnScanReceipt" class="scan-receipt-btn">
  ğŸ“· Skeniraj raÄun
</button>

    <button id="toggleArchive" class="archive-toggle">
  PrikaÅ¾i arhivu
</button>

<div id="shoppingSwipeHint" class="swipe-hint hidden">
  â† Povuci ulijevo za brisanje
</div>

<ul id="shoppingList" class="shopping-list"></ul>

<div id="shoppingEmpty" class="empty-state">
      <div class="empty-emoji">ğŸ›’</div>
      <div class="empty-title" id="shoppingEmptyTitle">Nema stavki</div>
      <div class="empty-sub" id="shoppingEmptySub">
        Dodaj prvu stavku gore.
      </div>
    </div>
  </div>

  <!-- POPUP ZA OBVEZE -->
  <div id="obligationsPopup" class="popup-balloon">
    <div class="balloon-content">
      <button class="balloon-btn" id="btnAddObligation">â• Dodaj obvezu</button>
      <button class="balloon-btn" id="btnViewObligations">ğŸ“… Pregled obveza</button>
    </div>
  </div>

  <!-- EKRAN: DODAVANJE/UREÄIVANJE OBVEZE -->
  <div id="screen-add-obligation" class="screen">
    <button class="back" id="backToAddObligation">â†</button>
    <div class="obligation-form">
      <input type="text" id="obligationTitle" placeholder="Naslov obveze" maxlength="100">
      <textarea id="obligationNote" placeholder="Napomena" rows="3"></textarea>

      <label class="datetime-label">
        <span id="obligationDateTimeLabel">Datum i vrijeme</span>
        <input type="datetime-local" id="obligationDateTime">
      </label>

      <label class="reminder-checkbox">
        <input type="checkbox" id="enableReminder">
        <span id="reminderLabel">Podsjetnik</span>
      </label>
      <label class="reminder-checkbox">
        <input type="checkbox" id="urgentObligation">
        <span id="urgentLabel"></span>
     </label>

      <div id="reminderOptions" class="hidden">
        <select id="reminderTime">
  <option value="30"></option>
  <option value="60"></option>
  <option value="120"></option>
  <option value="1440"></option>
</select>
      </div>
<label class="repeat-label">
  <span id="repeatLabel"></span>
  <select id="repeatType">
    <option value=""></option>
    <option value="daily"></option>
    <option value="weekly"></option>
  </select>
</label>
<label class="quiet-hours-label">
  <span id="quietHoursLabel"></span>
  <div class="quiet-hours-row">
    <input type="time" id="quietStart" value="22:00">
    <span>â€“</span>
    <input type="time" id="quietEnd" value="07:00">
  </div>
</label>

      <button id="saveObligation" class="btn-save">ğŸ’¾ Spremi</button>
      <button id="cancelObligation" class="btn-cancel"></button>
    </div>
  </div>

  <!-- EKRAN: PREGLED OBVEZA -->
  <div id="screen-obligations-list" class="screen">
    <button class="back" id="backToObligationsList">â†</button>

    <!-- TOOLBAR -->
    <div class="obligations-toolbar">
      <button id="btnViewByDays" class="toolbar-btn">
        ğŸ“† Pregled po danima
      </button>
    </div>

    <!-- DATE PICKER â€“ samo za daily view -->
    <div id="dailyDateBar" class="hidden" style="padding: 8px 12px;">
      <input
        type="date"
        id="dailyDatePicker"
        style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.15);"
      >
    </div>

    <!-- LIST VIEW -->
    <div id="obligationsContainer" class="obligations-list"></div>

    <!-- DAILY VIEW -->
    <div id="dailyView" class="hidden" style="padding: 0 12px 16px;">
      <div id="dailyOpenWrap"></div>
      <div id="dailyDoneWrap"></div>
    </div>
  </div>

</div> <!-- .app -->
<!-- APP VERSION -->
<div id="appVersion" style="
  position: fixed;
  bottom: 4px;
  right: 8px;
  font-size: 11px;
  opacity: 0.6;
  pointer-events: none;
"></div>

<!-- SKRIPTOVE -->
<script src="core/i18n.js"></script>
<script src="core/db.js"></script>

<script type="module">
// ===== APP VERSION =====
const APP_VERSION = "0.1.0";

// ===== BATTERY OPTIMIZATION CHECK =====
import { checkBatteryOptimization } from './core/battery.js';
document.getElementById("appVersion").textContent = "v" + APP_VERSION;
// ===== GLOBAL CONFIG =====
const CONFIG = {
  notificationsEnabled: true,
  serviceWorkerEnabled: true,
  debug: false
};
// ===== INIT SERVICE WORKER (guarded) =====
if (CONFIG.serviceWorkerEnabled) {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.log("SW registration error:", err));
  }
}
/* ===== HELPERS ===== */
/* ===== HELPERS ===== */
function getLang() {
  return localStorage.getItem('userLang') || 'hr';
}

// âœ… DETEKCIJA TOUCH UREÄAJA (MOBITEL / TABLET)
const IS_TOUCH_DEVICE =
  'ontouchstart' in window ||
  navigator.maxTouchPoints > 0;

function getISODateFromDateTime(dateTimeStr) {
  if (!dateTimeStr) return null;
  return String(dateTimeStr).split('T')[0] || null;
}

function todayISO() {
  return new Date().toISOString().split('T')[0];
}

function showScreen(screenId) {
  const screens = document.querySelectorAll('.screen');
  const next = document.getElementById(screenId);

  // potpuno sakrij sve
  screens.forEach(screen => {
    screen.classList.remove('active');
    screen.style.display = 'none';
  });

  // prikaÅ¾i samo traÅ¾eni
  if (next) {
    next.classList.add('active');
    next.style.display = 'block';
  }
}

/* ===== SET LANGUAGE + SHOW MENU ===== */
function setLanguage(lang) {
  localStorage.setItem('userLang', lang);
  document.documentElement.setAttribute('lang', lang);

  if (typeof I18N === 'undefined' || !I18N[lang]) {
    showScreen('screen-menu');
    return;
  }

  document.getElementById('btnObligations').textContent = I18N[lang].menu.obligations;
  document.getElementById('btnShopping').textContent = I18N[lang].menu.shopping;
  document.getElementById('btnContacts').textContent = I18N[lang].menu.contacts;
  document.getElementById('btnFinances').textContent = I18N[lang].menu.finances;
  document.getElementById('btnHealth').textContent = I18N[lang].menu.health;
  document.getElementById('btnDiary').textContent = I18N[lang].menu.diary;

  // ===== FINANCES MENU + SCREENS (guarded) =====
  if (I18N[lang].finances) {
// --- FINANCES MENU TITLE ---
    const finTitle = document.querySelector('#screen-finances-menu h2');
    if (finTitle) finTitle.textContent = I18N[lang].menu.finances;

    // --- FINANCES MENU ---
    document.getElementById('btnIncomeScreen').textContent = I18N[lang].finances.menu.income;
    document.getElementById('btnMonthlyCostsScreen').textContent = I18N[lang].finances.menu.fixed;
    document.getElementById('btnCreditsScreen').textContent = I18N[lang].finances.menu.credits;
    document.getElementById('btnOtherCostsScreen').textContent = I18N[lang].finances.menu.other;
    document.getElementById('btnCostsOverview').textContent = I18N[lang].finances.menu.overview;

    // --- FINANCE SCREEN TITLES ---
    document.querySelector('#screen-finance-income h2').textContent = I18N[lang].finances.income.title;
    document.querySelector('#screen-finance-fixed h2').textContent = I18N[lang].finances.fixed.title;
    document.querySelector('#screen-finance-credits h2').textContent = I18N[lang].finances.credits.title;
    document.querySelector('#screen-finance-other h2').textContent = I18N[lang].finances.other.title;
    document.querySelector('#screen-finance-overview h2').textContent = I18N[lang].finances.overview.title;

// --- FINANCE INCOME PLACEHOLDERS ---
    const incAmount = document.getElementById('incomeAmount');
    const incDesc = document.getElementById('incomeDesc');
    if (incAmount) incAmount.placeholder = I18N[lang].finances.income.amountPh;
    if (incDesc) incDesc.placeholder = I18N[lang].finances.income.descPh;
    const incomeDateLabel = document.getElementById('incomeDateLabel');
    if (incomeDateLabel) incomeDateLabel.textContent = I18N[lang].finances.income.dateLabel;

// --- FINANCE FIXED PLACEHOLDERS ---
    const fixedDesc = document.getElementById('fixedDesc');
    const fixedAmount = document.getElementById('fixedAmount');
    if (fixedDesc) fixedDesc.placeholder = I18N[lang].finances.fixed.descPh;
    if (fixedAmount) fixedAmount.placeholder = I18N[lang].finances.fixed.amountPh;

 // --- FINANCE CREDITS PLACEHOLDERS ---
    const creditDesc = document.getElementById('creditDesc');
    const creditAmount = document.getElementById('creditAmount');
    if (creditDesc) creditDesc.placeholder = I18N[lang].finances.credits.descPh;
    if (creditAmount) creditAmount.placeholder = I18N[lang].finances.credits.amountPh;

// --- FINANCE CREDITS LABELS ---
    const creditStartLabel = document.getElementById('creditStartLabel');
    const creditEndLabel = document.getElementById('creditEndLabel');
    const creditLastPaidLabel = document.getElementById('creditLastPaidLabel');

    if (creditStartLabel) creditStartLabel.textContent = I18N[lang].finances.credits.startLabel;
    if (creditEndLabel) creditEndLabel.textContent = I18N[lang].finances.credits.endLabel;
    if (creditLastPaidLabel) creditLastPaidLabel.textContent = I18N[lang].finances.credits.lastPaidLabel;

// --- FINANCE OTHER COSTS PLACEHOLDERS ---
    const otherDesc = document.getElementById('otherDesc');
    const otherAmount = document.getElementById('otherAmount');
    if (otherDesc) otherDesc.placeholder = I18N[lang].finances.other.descPh;
    if (otherAmount) otherAmount.placeholder = I18N[lang].finances.other.amountPh;

    // --- FINANCE BUTTONS ---
    document.getElementById('saveIncome').textContent = "â• " + I18N[lang].finances.income.add;
    document.getElementById('saveFixed').textContent = "â• " + I18N[lang].finances.fixed.add;
    document.getElementById('saveCredit').textContent = "â• " + I18N[lang].finances.credits.add;
    document.getElementById('saveOther').textContent = "â• " + I18N[lang].finances.other.add;
    document.getElementById('btnCalculateMonth').textContent = I18N[lang].finances.overview.calculate;
  }
  showScreen('screen-menu');

  setTimeout(() => {
    document.querySelectorAll('.menu-item').forEach((item, i) => {
      setTimeout(() => item.classList.add('animate'), 150 * i);
    });
  }, 50);
}

/* ===== OTVORI FORMU ZA UREÄIVANJE ===== */
function openEditForm(ob) {
  showScreen('screen-add-obligation');

  const lang = document.documentElement.getAttribute('lang') || getLang();

  document.getElementById('obligationTitle').value = ob.title;
  document.getElementById('obligationNote').value = ob.note || '';
  document.getElementById('obligationDateTime').value = ob.dateTime || '';
  document.getElementById('enableReminder').checked = !!ob.reminder;
  const urgentCheckbox = document.getElementById('urgentObligation');
if (urgentCheckbox) {
  urgentCheckbox.checked = !!ob.urgent;
}
  document.getElementById('reminderOptions').classList.toggle('hidden', !ob.reminder);
const reminderSelect = document.getElementById('reminderTime');
reminderSelect.querySelector('option[value="30"]').textContent = I18N[lang].obligationsList.reminder30;
reminderSelect.querySelector('option[value="60"]').textContent = I18N[lang].obligationsList.reminder60;
reminderSelect.querySelector('option[value="120"]').textContent = I18N[lang].obligationsList.reminder120;
reminderSelect.querySelector('option[value="1440"]').textContent = I18N[lang].obligationsList.reminder1440;
  document.getElementById('urgentLabel').textContent = I18N[lang].obligation.urgent;
  if (ob.reminder) document.getElementById('reminderTime').value = ob.reminder;

  document.getElementById('saveObligation').textContent = I18N[lang].obligation.update;
  document.getElementById('saveObligation').dataset.editId = ob.id;
  document.getElementById('cancelObligation').textContent = `âœ–ï¸ ${I18N[lang].obligation.cancel}`;
const repeatSelect = document.getElementById('repeatType');
if (repeatSelect) {
  repeatSelect.value = ob.repeat || '';

  document.getElementById('repeatLabel').textContent = I18N[lang].obligation.repeat;

  repeatSelect.querySelector('option[value=""]').textContent = I18N[lang].obligation.repeatNone;
  repeatSelect.querySelector('option[value="daily"]').textContent = I18N[lang].obligation.repeatDaily;
  repeatSelect.querySelector('option[value="weekly"]').textContent = I18N[lang].obligation.repeatWeekly;
}
}

/* ===== RENDER CARD (reused) ===== */
function buildObligationCard(ob, lang) {
  const dt = ob.dateTime ? new Date(ob.dateTime) : null;
  const dateStr = dt ? dt.toLocaleDateString(I18N[lang].lang || 'hr-HR') : 'â€”';
  const timeStr = dt ? dt.toLocaleTimeString(I18N[lang].lang || 'hr-HR', { hour: '2-digit', minute: '2-digit' }) : 'â€”';

  let reminderStr = '';
  if (ob.reminder) {
    const key = `reminder${ob.reminder}`;
    reminderStr = I18N[lang].obligationsList[key] || `${ob.reminder} min`;
  }

  let repeatIcon = '';
let repeatTitle = '';

if (ob.repeat) {
  repeatIcon = ' ğŸ”';

  if (ob.repeat === 'daily') repeatTitle = 'Svaki dan';
  else if (ob.repeat === 'weekly') repeatTitle = 'Svaki tjedan';
  else if (ob.repeat === 'monthly') repeatTitle = 'Svaki mjesec';
  else repeatTitle = 'PrilagoÄ‘eno';
}
  const statusText = ob.status === 'done'
    ? `âœ… ${I18N[lang].obligationsList.statusDone}`
    : `â³ ${I18N[lang].obligationsList.statusActive}`;

  const bgColor = ob.status === 'done' ? '#e8f5e9' : '#e3f2fd';
  const borderColor = ob.status === 'done' ? '#4caf50' : '#2196f3';

  const toggleBtnText = ob.status === 'done'
    ? I18N[lang].obligationsList.markActive
    : I18N[lang].obligationsList.markDone;

  return `
    <div class="obligation-card" data-id="${ob.id}" style="background:${bgColor}; border-left:4px solid ${borderColor};">
      <div class="obligation-title" title="${repeatTitle}">${ob.title}${repeatIcon}</div>
      ${ob.note ? `<div class="obligation-note">${ob.note}</div>` : ''}
      <div class="obligation-meta">
        <div class="obligation-date">ğŸ“… ${dateStr}</div>
        <div class="obligation-time">â° ${timeStr}</div>
        ${reminderStr ? `<div class="obligation-reminder">ğŸ”” ${reminderStr}</div>` : ''}
        <div class="obligation-status">${statusText}</div>
      </div>
      <button class="obligation-toggle-status" data-id="${ob.id}" data-status="${ob.status}">
        ${toggleBtnText}
      </button>
      <button class="obligation-edit" data-id="${ob.id}">âœï¸ ${I18N[lang].obligationsList.edit}</button>
      <button
        class="obligation-delete"
        data-id="${ob.id}"
        title="${I18N[lang].obligationsList.delete || 'ObriÅ¡i'}"
        aria-label="${I18N[lang].obligationsList.delete || 'ObriÅ¡i'}"
      >
        ğŸ—‘ï¸
      </button>
    </div>
  `;
}

function attachObligationHandlers(container) {
  // PROMJENA STATUSA
  container.querySelectorAll('.obligation-toggle-status').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const currentStatus = btn.dataset.status;
      const newStatus = currentStatus === 'done' ? 'active' : 'done';

      const obligations = await obligationDB.getAll();
      const obligation = obligations.find(o => o.id === id);
      if (!obligation) return;

      obligation.status = newStatus;
await obligationDB.add(obligation);

if (newStatus === 'done') {
  import('./core/notifications.js').then(async ({
    cancelObligationNotification,
    scheduleObligationNotification
  }) => {
    cancelObligationNotification(id);

    if (
  obligation.repeat &&
  obligation.dateTime &&
  !obligation.repeatPaused
) {
if (obligation.skipNextRepeat) {
  obligation.skipNextRepeat = false;
  await obligationDB.add(obligation);
  return;
}
      const baseDate = new Date(obligation.dateTime);
      const nextDate = new Date(baseDate);
if (obligation.repeat === 'custom' && obligation.customRepeat) {
  const { unit, every } = obligation.customRepeat;
  const baseDate = new Date(obligation.dateTime);
  const nextDate = new Date(baseDate);

  if (unit === 'day') nextDate.setDate(baseDate.getDate() + every);
  if (unit === 'week') nextDate.setDate(baseDate.getDate() + every * 7);
  if (unit === 'month') nextDate.setMonth(baseDate.getMonth() + every);

  const nextObligation = {
    ...obligation,
    id: Date.now(),
    status: 'active',
    dateTime: nextDate.toISOString().slice(0, 16),
    createdAt: new Date().toISOString()
  };

  await obligationDB.add(nextObligation);
  await scheduleObligationNotification(nextObligation);
  return;
}

      if (obligation.repeat === 'daily') {
  nextDate.setDate(baseDate.getDate() + 1);
}

if (obligation.repeat === 'weekly') {
  nextDate.setDate(baseDate.getDate() + 7);
}

if (obligation.repeat === 'monthly') {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth() + 1; // next month
  const day = baseDate.getDate();

  // zadnji dan ciljanog mjeseca
  const lastDayOfTargetMonth = new Date(year, month + 1, 0).getDate();

  nextDate.setFullYear(year);
  nextDate.setMonth(month);
  nextDate.setDate(Math.min(day, lastDayOfTargetMonth));
}

      const nextObligation = {
        ...obligation,
        id: Date.now(),
        status: 'active',
        dateTime: nextDate.toISOString().slice(0, 16),
        createdAt: new Date().toISOString()
      };

      await obligationDB.add(nextObligation);
      await scheduleObligationNotification(nextObligation);
    }
  });
}

refreshCurrentObligationsView();
    });
  });

  // UREÄIVANJE
  container.querySelectorAll('.obligation-edit').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const obligations = await obligationDB.getAll();
      const ob = obligations.find(o => o.id === id);
      if (ob) openEditForm(ob);
    });
  });

  // BRISANJE
  container.querySelectorAll('.obligation-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const id = parseInt(btn.dataset.id, 10);
      const langNow = getLang();

      if (!confirm(I18N[langNow].obligationsList.deleteConfirm || 'Obrisati obvezu?')) {
        return;
      }

      await obligationDB.delete(id);

      import('./core/notifications.js').then(({ cancelObligationNotification }) => {
        cancelObligationNotification(id);
      });

      refreshCurrentObligationsView();
    });
  });
}

/* ===== DAILY VIEW LOGIC ===== */
let viewMode = 'list'; // 'list' | 'days'
let currentDailyDate = todayISO();

function showListMode() {
  viewMode = 'list';

  const dailyView = document.getElementById('dailyView');
  const dailyDateBar = document.getElementById('dailyDateBar');
  const list = document.getElementById('obligationsContainer');
  const btn = document.getElementById('btnViewByDays');

  if (dailyView) dailyView.classList.add('hidden');
  if (dailyDateBar) dailyDateBar.classList.add('hidden');
  if (list) list.classList.remove('hidden');

  const lang = getLang();
  if (btn) btn.textContent = I18N[lang].obligationsView.byDay;
}

function showDailyMode() {
  viewMode = 'days';

  const dailyView = document.getElementById('dailyView');
  const dailyDateBar = document.getElementById('dailyDateBar');
  const list = document.getElementById('obligationsContainer');
  const btn = document.getElementById('btnViewByDays');

  if (list) list.classList.add('hidden');
  if (dailyView) dailyView.classList.remove('hidden');
  if (dailyDateBar) dailyDateBar.classList.remove('hidden');

  const lang = getLang();
  if (btn) btn.textContent = I18N[lang].obligationsView.asList;
}

function groupObligationsByStatus(items) {
  return {
    open: items.filter(i => i.status !== 'done'),
    done: items.filter(i => i.status === 'done')
  };
}

async function loadDailyForDate(isoDate) {
  currentDailyDate = isoDate;

  const picker = document.getElementById('dailyDatePicker');
  if (picker && picker.value !== isoDate) picker.value = isoDate;

  const lang = getLang();
  const all = (await obligationDB.getAll())
  .filter(o => o.type !== 'shopping');

const filtered = all.filter(o =>
  getISODateFromDateTime(o.dateTime) === isoDate
);
  const groups = groupObligationsByStatus(filtered);

  const openWrap = document.getElementById('dailyOpenWrap');
  const doneWrap = document.getElementById('dailyDoneWrap');
  const emptyHtml = `<div class="empty-list">${I18N[lang].obligationsList.noObligations}</div>`;

  if (groups.open.length === 0) {
    openWrap.innerHTML = `<div class="empty-list">â€”</div>`;
  } else {
    openWrap.innerHTML = `
      <div style="font-weight:800; margin:8px 0;">Aktivne (${groups.open.length})</div>
      ${groups.open.map(ob => buildObligationCard(ob, lang)).join('')}
    `;
    attachObligationHandlers(openWrap);
  }

  if (groups.done.length === 0) {
    doneWrap.innerHTML = `<div class="empty-list">â€”</div>`;
  } else {
    doneWrap.innerHTML = `
      <div style="font-weight:800; margin:8px 0;">ZavrÅ¡ene (${groups.done.length})</div>
      ${groups.done.map(ob => buildObligationCard(ob, lang)).join('')}
    `;
    attachObligationHandlers(doneWrap);
  }

  if (groups.open.length === 0 && groups.done.length === 0) {
    openWrap.innerHTML = emptyHtml;
    doneWrap.innerHTML = '';
  }
}

function refreshCurrentObligationsView() {
  if (viewMode === 'days') {
    loadDailyForDate(currentDailyDate);
  } else {
    renderObligationsList();
  }
}

/* ===== LIST VIEW RENDER ===== */
async function renderObligationsList() {
  if (viewMode === 'days') return;

  const container = document.getElementById('obligationsContainer');
  const lang = getLang();

  const obligations = (await obligationDB.getAll())
  .filter(o =>
    o.type !== 'shopping' &&
    o.status !== 'done'
  );

  obligations.sort((a, b) => {
    if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
    if (!a.dateTime) return 1;
    if (!b.dateTime) return -1;
    return new Date(b.dateTime) - new Date(a.dateTime);
  });

  if (obligations.length === 0) {
    container.innerHTML = `<div class="empty-list">${I18N[lang].obligationsList.noObligations}</div>`;
    return;
  }

  container.innerHTML = obligations.map(ob => buildObligationCard(ob, lang)).join('');
  attachObligationHandlers(container);
}

/* ===== SHOPPING (IndexedDB + Archive) ===== */
let shoppingItems = [];
let showArchivedShopping = false;

function renderShoppingList() {
  const list = document.getElementById('shoppingList');
  const empty = document.getElementById('shoppingEmpty');

  if (!list || !empty) return;

  list.innerHTML = '';

  const visibleItems = showArchivedShopping
    ? shoppingItems
    : shoppingItems.filter(item => !item.checked);

  if (visibleItems.length === 0) {
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';

  visibleItems.forEach(item => {
    const li = document.createElement('li');
li.className = 'shopping-item';

li.innerHTML = `
  <div class="shopping-item-delete">ğŸ—‘ï¸</div>
  <div class="shopping-item-content">${item.title}</div>
`;

if (item.checked) li.classList.add('checked');

// tap / click = check
li.addEventListener('click', () => {
  item.checked = !item.checked;
  renderShoppingList();
  addShoppingItem(item); // âœ… koristi db.js add/put
});

// ===== MOBILE ONLY: swipe to delete (FINAL) =====
if (IS_TOUCH_DEVICE) {
  let startX = 0;
  let currentX = 0;
  let swiping = false;
  const DELETE_THRESHOLD = 120; // px

  li.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    currentX = startX;
    swiping = true;
  }, { passive: true });

// oznaÄi da je swipe zapoÄeo (za CSS)
li.classList.add('swiping');
// ğŸ” MICRO HINT â€“ show on first swipe only
const hint = document.getElementById('shoppingSwipeHint');
const hintSeen = localStorage.getItem('shoppingSwipeHintSeen');

if (IS_TOUCH_DEVICE && hint && !hintSeen) {
  hint.classList.remove('hidden');

  setTimeout(() => {
    hint.style.opacity = '0';
    setTimeout(() => {
      hint.classList.add('hidden');
      hint.style.opacity = '';
    }, 300);
  }, 2500);

  localStorage.setItem('shoppingSwipeHintSeen', '1');
}

  li.addEventListener('touchmove', e => {
    if (!swiping) return;

    currentX = e.touches[0].clientX;
    const diff = currentX - startX;

    if (diff < 0) {
      const MAX_SWIPE = 84; // px â€“ isto kao Å¡irina delete zone
const limited = Math.max(diff, -MAX_SWIPE);
li.style.transform = `translateX(${limited}px)`;
    }
  }, { passive: true });

  li.addEventListener('touchend', () => {
    if (!swiping) return;
    swiping = false;
  li.classList.remove('swiping');

    const diff = currentX - startX;

    if (diff < -DELETE_THRESHOLD) {
      // âœ… DELETE
      shoppingItems = shoppingItems.filter(i => i.id !== item.id);
      renderShoppingList();
      deleteShoppingItem(item.id);
    } else {
      // â¬…ï¸ SNAP BACK
      li.style.transition = 'transform 0.15s ease-out';
      li.style.transform = 'translateX(0)';

      setTimeout(() => {
        li.style.transition = '';
      }, 150);
    }
  });
}

// ===== MOBILE: swipe left delete (content only) =====
const content = li.querySelector('.shopping-item-content');

// swipe disabled for stability

    // DESKTOP: right-click delete
    li.addEventListener('contextmenu', e => {
      e.preventDefault();
      shoppingItems = shoppingItems.filter(i => i.id !== item.id);
      renderShoppingList();
      deleteShoppingItem(item.id);
    });

    list.appendChild(li);
  });
}

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', () => {
// ===== FORCE START SCREEN =====
  showScreen('screen-lang');

  // ===== SAVE INCOME =====
  document.getElementById('saveIncome').addEventListener('click', async () => {
  const amount = parseFloat(document.getElementById('incomeAmount').value);
  const desc = document.getElementById('incomeDesc').value.trim();
  const date = document.getElementById('incomeDate').value;

  if (!amount || !date) return alert('Unesi iznos i datum');

  const editId = document.getElementById('saveIncome').dataset.editId;
  const isEdit = !!editId;

  const item = {
    id: isEdit ? Number(editId) : Date.now(),
    type: 'income',
    amount,
    desc: desc || 'Prihod',
    date
  };

  await addFinanceItem(item);

  // reset forme
  document.getElementById('incomeAmount').value = '';
  document.getElementById('incomeDesc').value = '';
  document.getElementById('incomeDate').value = '';
  document.getElementById('saveIncome').removeAttribute('data-edit-id');

  renderIncomeList();
});

// ===== RENDER INCOME LIST =====
  async function renderIncomeList() {
    const list = document.getElementById('incomeList');
    if (!list) return;

    const items = await getFinanceItems();
    const incomes = items.filter(i => i.type === 'income');

    incomes.sort((a, b) => b.id - a.id);

    if (incomes.length === 0) {
      list.innerHTML = '<div class="empty-list">Nema prihoda</div>';
      return;
    }

    list.innerHTML = incomes.map(i => `
  <div class="finance-item" data-id="${i.id}" style="position:relative;">

    <div><strong>${i.amount} â‚¬</strong> â€“ ${i.desc}</div>
    <div>${new Date(i.date).toLocaleDateString('hr-HR')}</div>

    <button class="finance-edit" data-id="${i.id}">âœï¸</button>

    <button class="finance-delete" data-id="${i.id}"
      style="position:absolute; bottom:6px; right:6px; border:none; background:none; font-size:18px;">
      ğŸ—‘ï¸
    </button>

  </div>
`).join('');

    // --- DELETE ---
    list.querySelectorAll('.finance-delete').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = Number(btn.dataset.id);
        await deleteFinanceItem(id);
        renderIncomeList();
      });
    });

    // --- EDIT ---
    list.querySelectorAll('.finance-edit').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = Number(btn.dataset.id);
        const items = await getFinanceItems();
        const item = items.find(x => x.id === id);
        if (!item) return;

        document.getElementById('incomeAmount').value = item.amount;
        document.getElementById('incomeDesc').value = item.desc;
        document.getElementById('incomeDate').value = item.date;

        document.getElementById('saveIncome').dataset.editId = id;
      });
    });
  }

  // ===== SAVE FIXED =====
  document.getElementById('saveFixed').addEventListener('click', async () => {
  const desc = document.getElementById('fixedDesc').value.trim();
  const amount = parseFloat(document.getElementById('fixedAmount').value);

  if (!desc || !amount) return alert('Unesi naziv i iznos');

  const editId = document.getElementById('saveFixed').dataset.editId;
  const isEdit = !!editId;

  const item = {
    id: isEdit ? Number(editId) : Date.now(),
    type: 'fixed',
    desc,
    amount
  };

  await addFinanceItem(item);

  document.getElementById('fixedDesc').value = '';
  document.getElementById('fixedAmount').value = '';
  document.getElementById('saveFixed').removeAttribute('data-edit-id');

  renderFixedList();
});

  // ===== SAVE CREDIT =====
  document.getElementById('saveCredit').addEventListener('click', async () => {
  const desc = document.getElementById('creditDesc').value.trim();
  const amount = parseFloat(document.getElementById('creditAmount').value);
  const start = document.getElementById('creditStart').value;
  const end = document.getElementById('creditEnd').value;
  const lastPaid = document.getElementById('creditLastPaid').value;

  if (!desc || !amount || !start || !end) {
    return alert('Unesi sve podatke kredita');
  }

  const editId = document.getElementById('saveCredit').dataset.editId;
  const isEdit = !!editId;

  const item = {
    id: isEdit ? Number(editId) : Date.now(),
    type: 'credit',
    desc,
    amount,
    start,
    end,
    lastPaid: lastPaid || null
  };

  await addFinanceItem(item);

  document.getElementById('creditDesc').value = '';
  document.getElementById('creditAmount').value = '';
  document.getElementById('creditStart').value = '';
  document.getElementById('creditEnd').value = '';
  document.getElementById('creditLastPaid').value = '';
  document.getElementById('saveCredit').removeAttribute('data-edit-id');

  renderCreditList();
});

  // ===== BATTERY OPTIMIZATION =====
  checkBatteryOptimization();

  // ===== QUIET HOURS =====
  const quietStartInput = document.getElementById('quietStart');
  const quietEndInput = document.getElementById('quietEnd');

  if (quietStartInput && quietEndInput) {
    quietStartInput.value = localStorage.getItem('quietStart') || '22:00';
    quietEndInput.value = localStorage.getItem('quietEnd') || '07:00';

    quietStartInput.addEventListener('change', () => {
      localStorage.setItem('quietStart', quietStartInput.value);
    });

    quietEndInput.addEventListener('change', () => {
      localStorage.setItem('quietEnd', quietEndInput.value);
    });
  }

  // ===== SERVICE WORKER SNOOZE =====
  navigator.serviceWorker?.addEventListener('message', e => {
    if (e.data?.type === 'SNOOZE') {
      import('./core/notifications.js').then(({ snoozeObligation }) => {
        obligationDB.getAll().then(items => {
          const ob = items.find(o => o.id === e.data.obligationId);
          if (ob) snoozeObligation(ob, e.data.minutes);
        });
      });
    }
  });

// JEZICI
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      setLanguage(btn.dataset.lang);
    });
  });

  // BACK - MENU
  document.getElementById('backMenu').addEventListener('click', () => {
    showScreen('screen-lang');
    document.querySelectorAll('.menu-item')
      .forEach(item => item.classList.remove('animate'));
  });

  // BACK - SHOPPING
  document.getElementById('backShopping').addEventListener('click', () => {
    showScreen('screen-menu');
  });
document.getElementById('backFinanceIncome').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});
document.getElementById('backFinanceFixed').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});
document.getElementById('backFinanceCredits').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});
document.getElementById('backFinanceOther').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});
document.getElementById('backFinanceOverview').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});

  // SHOPPING BUTTON (open + load + focus)
// FINANCES BUTTON
document.getElementById('btnFinances').addEventListener('click', () => {
  showScreen('screen-finances-menu');
});

  // BACK - FINANCES MENU
const backFin = document.getElementById('backFinancesMenu');
if (backFin) {
  backFin.addEventListener('click', () => showScreen('screen-menu'));
}


// ===== FINANCES: FIXED EXPENSES =====

async function renderFixedList() {
  const list = document.getElementById('fixedList');
  if (!list) return;

  const items = await getFinanceItems();
  const fixed = items.filter(i => i.type === 'fixed');

  fixed.sort((a, b) => b.id - a.id);

  if (fixed.length === 0) {
    list.innerHTML = '<div class="empty-list">Nema fiksnih troÅ¡kova</div>';
    return;
  }

  list.innerHTML = fixed.map(i => `
  <div class="finance-item" data-id="${i.id}" style="position:relative;">

    <div><strong>${i.amount} â‚¬</strong> â€“ ${i.desc}</div>

    <button class="finance-edit-fixed" data-id="${i.id}">âœï¸</button>

    <button class="finance-delete-fixed" data-id="${i.id}"
      style="position:absolute; bottom:6px; right:6px; border:none; background:none; font-size:18px;">
      ğŸ—‘ï¸
    </button>

  </div>
`).join('');

  // --- DELETE ---
  list.querySelectorAll('.finance-delete-fixed').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      await deleteFinanceItem(id);
      renderFixedList();
    });
  });

  // --- EDIT ---
  list.querySelectorAll('.finance-edit-fixed').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      const items = await getFinanceItems();
      const item = items.find(x => x.id === id);
      if (!item) return;

      document.getElementById('fixedDesc').value = item.desc;
      document.getElementById('fixedAmount').value = item.amount;

      document.getElementById('saveFixed').dataset.editId = id;
    });
  });
}
// ===== FINANCES: CREDITS =====

async function renderCreditList() {
  const list = document.getElementById('creditList');
  if (!list) return;

  const items = await getFinanceItems();
  const credits = items.filter(i => i.type === 'credit');

  credits.sort((a, b) => b.id - a.id);

  if (credits.length === 0) {
    list.innerHTML = '<div class="empty-list">Nema kredita</div>';
    return;
  }

  list.innerHTML = credits.map(c => `
  <div class="finance-item" data-id="${c.id}" style="position:relative;">

    <div><strong>${c.amount} â‚¬</strong> â€“ ${c.desc}</div>
    <div>PoÄetak: ${new Date(c.start).toLocaleDateString('hr-HR')}</div>
    <div>ZavrÅ¡etak: ${new Date(c.end).toLocaleDateString('hr-HR')}</div>
    <div>Zadnja uplata: ${c.lastPaid ? new Date(c.lastPaid).toLocaleDateString('hr-HR') : '-'}</div>

    <button class="finance-edit-credit" data-id="${c.id}">âœï¸</button>

    <button class="finance-delete-credit" data-id="${c.id}"
      style="position:absolute; bottom:6px; right:6px; border:none; background:none; font-size:18px;">
      ğŸ—‘ï¸
    </button>

  </div>
`).join('');

  // --- DELETE ---
  list.querySelectorAll('.finance-delete-credit').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      await deleteFinanceItem(id);
      renderCreditList();
    });
  });

  // --- EDIT ---
  list.querySelectorAll('.finance-edit-credit').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      const items = await getFinanceItems();
      const item = items.find(x => x.id === id);
      if (!item) return;

      document.getElementById('creditDesc').value = item.desc;
      document.getElementById('creditAmount').value = item.amount;
      document.getElementById('creditStart').value = item.start;
      document.getElementById('creditEnd').value = item.end;
      document.getElementById('creditLastPaid').value = item.lastPaid || '';

      document.getElementById('saveCredit').dataset.editId = id;
    });
  });
}
// ===== FINANCES: MONTHLY CALCULATION =====

async function calculateMonth() {
  const monthInput = document.getElementById('financeMonth').value;
  if (!monthInput) return alert('Odaberi mjesec');

  const [year, month] = monthInput.split('-');
  const items = await getFinanceItems();

  // --- INCOME ---
  const incomes = items.filter(i =>
    i.type === 'income' &&
    i.date &&
    i.date.startsWith(`${year}-${month}`)
  );
  const totalIncome = incomes.reduce((sum, i) => sum + Number(i.amount), 0);

  // --- FIXED ---
  const fixed = items.filter(i => i.type === 'fixed');
  const totalFixed = fixed.reduce((sum, i) => sum + Number(i.amount), 0);

  // --- CREDITS ---
  const credits = items.filter(i => i.type === 'credit');
  let activeCredits = [];
  let totalCredits = 0;

  credits.forEach(c => {
    if (!c.start || !c.end) return;

    const startMonth = c.start.slice(0,7);
    const endMonth = c.end.slice(0,7);

    if (monthInput >= startMonth && monthInput <= endMonth) {
      totalCredits += Number(c.amount);
      activeCredits.push(c);
    }
  });

  // --- OTHER COSTS ---
  const otherCosts = items.filter(i =>
    i.type === 'otherCost' &&
    i.date &&
    i.date.startsWith(`${year}-${month}`)
  );
  const totalOther = otherCosts.reduce((sum, i) => sum + Number(i.amount), 0);

  // --- FINAL ---
  const result = totalIncome - totalFixed - totalCredits - totalOther;

  const out = document.getElementById('monthResult');
const lang = document.documentElement.getAttribute('lang') || getLang();

let html = `
  <div class="finance-item"><strong>${I18N[lang].finances.overview.sumIncome}:</strong> ${totalIncome.toFixed(2)} â‚¬</div>
  <div class="finance-item"><strong>${I18N[lang].finances.overview.sumFixed}:</strong> ${totalFixed.toFixed(2)} â‚¬</div>
  <div class="finance-item"><strong>${I18N[lang].finances.overview.sumCredits}:</strong> ${totalCredits.toFixed(2)} â‚¬</div>
  <div class="finance-item"><strong>${I18N[lang].finances.overview.sumOther}:</strong> ${totalOther.toFixed(2)} â‚¬</div>
  <div class="finance-item" style="font-weight:800;">
    ${I18N[lang].finances.overview.sumResult}: ${result.toFixed(2)} â‚¬
  </div>
  <hr>
`;

  // ===== INCOME LIST =====
  if (incomes.length > 0) {
    html += `<div class="finance-item" style="text-align:center; font-weight:800;">${I18N[lang].finances.overview.listIncome}</div>`;
    incomes.forEach(i => {
      html += `<div class="finance-item">ğŸ’µ ${i.desc} â€” ${Number(i.amount).toFixed(2)} â‚¬</div>`;
    });
  }

  // ===== FIXED LIST =====
  if (fixed.length > 0) {
    html += `<div class="finance-item" style="text-align:center; font-weight:800;">${I18N[lang].finances.overview.listFixed}</div>`;
    fixed.forEach(f => {
      html += `<div class="finance-item">ğŸ“… ${f.desc} â€” ${Number(f.amount).toFixed(2)} â‚¬</div>`;
    });
  }

  // ===== CREDIT LIST =====
  if (activeCredits.length > 0) {
    html += `<div class="finance-item" style="text-align:center; font-weight:800;">${I18N[lang].finances.overview.listCredits}</div>`;
    activeCredits.forEach(c => {
      html += `<div class="finance-item">ğŸ¦ ${c.desc} â€” ${Number(c.amount).toFixed(2)} â‚¬</div>`;
    });
  }

  // ===== OTHER COSTS LIST =====
  if (otherCosts.length > 0) {
    html += `<div class="finance-item" style="text-align:center; font-weight:800;">${I18N[lang].finances.overview.listOther}</div>`;
    otherCosts.forEach(o => {
      html += `<div class="finance-item">ğŸ›’ ${o.desc} â€” ${Number(o.amount).toFixed(2)} â‚¬</div>`;
    });
  }

  out.innerHTML = html;
}

// ===== CONNECT MONTH CALCULATE BUTTON =====
document.getElementById('btnCalculateMonth')
  .addEventListener('click', calculateMonth);

  
// ===== OTHER COSTS =====

async function renderOtherList() {
  const list = document.getElementById('otherList');
  if (!list) return;

  const items = (await getFinanceItems()).filter(i => i.type === 'otherCost');

  if (items.length === 0) {
    list.innerHTML = '<div class="empty-list">Nema troÅ¡kova</div>';
    return;
  }

  list.innerHTML = items.map(i => `
  <div class="finance-item" data-id="${i.id}" style="position:relative;">

    <div><strong>${i.desc}</strong></div>
    <div>â‚¬ ${Number(i.amount).toFixed(2)}</div>
    <div>${i.date ? new Date(i.date).toLocaleDateString('hr-HR') : ''}</div>

    <button class="finance-edit-other" data-id="${i.id}">âœï¸</button>

    <button class="finance-delete-other" data-id="${i.id}"
      style="position:absolute; bottom:6px; right:6px; border:none; background:none; font-size:18px;">
      ğŸ—‘ï¸
    </button>

  </div>
`).join('');

  // --- DELETE ---
  list.querySelectorAll('.finance-delete-other').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      await deleteFinanceItem(id);
      renderOtherList();
    });
  });

  // --- EDIT ---
  list.querySelectorAll('.finance-edit-other').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.dataset.id);
      const items = await getFinanceItems();
      const item = items.find(x => x.id === id);
      if (!item) return;

      document.getElementById('otherDesc').value = item.desc;
      document.getElementById('otherAmount').value = item.amount;

      document.getElementById('saveOther').dataset.editId = id;
    });
  });
}

document.getElementById('saveOther').addEventListener('click', async () => {
  const desc = document.getElementById('otherDesc').value.trim();
  const amount = document.getElementById('otherAmount').value;
  const date = new Date().toISOString().split('T')[0];

  if (!desc || !amount) return;

  const editId = document.getElementById('saveOther').dataset.editId;
  const isEdit = !!editId;

  const item = {
    id: isEdit ? Number(editId) : Date.now(),
    type: 'otherCost',
    desc,
    amount,
    date,
    createdAt: Date.now()
  };

  await addFinanceItem(item);

  document.getElementById('otherDesc').value = '';
  document.getElementById('otherAmount').value = '';
  document.getElementById('saveOther').removeAttribute('data-edit-id');

  renderOtherList();
});

// CALCULATE MONTH BUTTON
const calcBtn = document.getElementById('calcMonth');
if (calcBtn) {
  calcBtn.addEventListener('click', calculateMonth);
}

  document.getElementById('btnShopping').addEventListener('click', async () => {
    const lang = getLang();

    showScreen('screen-shopping');

    document.getElementById('shoppingTitle').textContent = I18N[lang].shopping.title;
    document.getElementById('shoppingInput').placeholder = I18N[lang].shopping.placeholder;
    document.getElementById('shoppingEmptyTitle').textContent = I18N[lang].shopping.emptyTitle;
    document.getElementById('shoppingEmptySub').textContent = I18N[lang].shopping.emptySub;

    const toggleBtn = document.getElementById('toggleArchive');
    toggleBtn.textContent = showArchivedShopping
      ? I18N[lang].shopping.hideArchive
      : I18N[lang].shopping.showArchive;

    shoppingItems = await getShoppingItems();

// âœ… zadrÅ¾i redoslijed unosa
shoppingItems.sort((a, b) => a.createdAt - b.createdAt);

renderShoppingList();

    setTimeout(() => document.getElementById('shoppingInput').focus(), 0);
  });

// ===== SCAN RECEIPT BUTTON =====
const scanBtn = document.getElementById('btnScanReceipt');

if (scanBtn) {
  scanBtn.addEventListener('click', async () => {
    const { Camera } = Capacitor.Plugins;

    try {
      const image = await Camera.getPhoto({
  quality: 80,
  allowEditing: false,
  resultType: 'dataUrl',

  source: 'camera',     // ğŸ‘ˆ forsira direktno kameru
  direction: 'rear'     // ğŸ‘ˆ forsira zadnju kameru
});

      // ===== OCR =====
      alert("Obrada raÄuna... â³");

      const worker = await Tesseract.createWorker('eng');
      const { data: { text } } = await worker.recognize(image.dataUrl);
      await worker.terminate();

      console.log("OCR tekst:", text);

      // ===== IZVLAÄŒENJE IZNOSA =====
      // traÅ¾i prvi broj s decimalom
      const match = text.match(/(\d+[.,]\d{2})/);

      if (match) {
  const amount = match[1].replace(',', '.');

  // ===== SPREMI U FINANCIJE - OSTALI TROÅ KOVI =====
  const item = {
    id: Date.now(),
    type: 'otherCost',
    desc: "RaÄun (OCR)",
    amount: Number(amount),
    date: new Date().toISOString().split('T')[0],
    createdAt: Date.now()
  };

  await addFinanceItem(item);

  alert("RaÄun spremljen u Ostale troÅ¡kove: " + amount + " â‚¬");

} else {
  alert("Iznos nije pronaÄ‘en ğŸ˜");
}

    } catch (err) {
      console.log("OCR error:", err);
      alert("GreÅ¡ka u OCR obradi");
    }
  });
}
// ===== FINANCES MENU BUTTON LINKS =====

document.getElementById('btnIncomeScreen').addEventListener('click', async () => {
  showScreen('screen-finance-income');
  await renderIncomeList();
});

document.getElementById('btnMonthlyCostsScreen').addEventListener('click', async () => {
  showScreen('screen-finance-fixed');
  await renderFixedList();
});

document.getElementById('btnCreditsScreen').addEventListener('click', async () => {
  showScreen('screen-finance-credits');
  await renderCreditList();
});

document.getElementById('btnOtherCostsScreen').addEventListener('click', async () => {
  showScreen('screen-finance-other');
  await renderOtherList();
});
document.getElementById('btnCostsOverview').addEventListener('click', () => {
  const lang = getLang();
  document.documentElement.setAttribute('lang', lang);
  showScreen('screen-finance-overview');
});

  // SHOPPING INPUT - Enter to add item
  const shoppingInput = document.getElementById('shoppingInput');
  if (shoppingInput) {
    shoppingInput.addEventListener('keydown', e => {
      if (e.key !== 'Enter') return;

      const title = shoppingInput.value.trim();
      if (!title) return;

      const item = {
        id: crypto.randomUUID(),
        title,
        checked: false,
        createdAt: Date.now()
      };

      shoppingItems.push(item);
      renderShoppingList();
      addShoppingItem(item);

      shoppingInput.value = '';
      shoppingInput.focus();
    });
  }

  // ARCHIVE TOGGLE
  const toggleArchiveBtn = document.getElementById('toggleArchive');
  if (toggleArchiveBtn) {
    toggleArchiveBtn.addEventListener('click', () => {
      showArchivedShopping = !showArchivedShopping;

      const lang = getLang();
      toggleArchiveBtn.textContent = showArchivedShopping
        ? I18N[lang].shopping.hideArchive
        : I18N[lang].shopping.showArchive;

      renderShoppingList();
    });
  }

  // POPUP OBVEZE (open)
  document.getElementById('btnObligations').addEventListener('click', () => {
    const popup = document.getElementById('obligationsPopup');
    const lang = getLang();

    document.getElementById('btnViewByDays').textContent = I18N[lang].obligationsView.byDay;
    document.getElementById('btnAddObligation').textContent = I18N[lang].menu.addObligation;
    document.getElementById('btnViewObligations').textContent = I18N[lang].menu.viewObligations;

    popup.style.display = 'block';
    setTimeout(() => popup.classList.add('animate'), 10);
  });

  // ZATVORI POPUP
  document.addEventListener('click', (e) => {
    const popup = document.getElementById('obligationsPopup');
    const btn = document.getElementById('btnObligations');
    if (popup.style.display === 'block' && !popup.contains(e.target) && e.target !== btn) {
      popup.classList.remove('animate');
      setTimeout(() => popup.style.display = 'none', 300);
    }
  });

  // FORMA ZA DODAVANJE
  document.getElementById('btnAddObligation').addEventListener('click', () => {
    const popup = document.getElementById('obligationsPopup');
    popup.classList.remove('animate');
    setTimeout(() => popup.style.display = 'none', 300);

    showScreen('screen-add-obligation');

    const lang = getLang();
    document.getElementById('obligationTitle').placeholder = I18N[lang].obligation.title;
    document.getElementById('obligationNote').placeholder = I18N[lang].obligation.note;
    document.getElementById('obligationDateTimeLabel').textContent = I18N[lang].obligation.dateTime;
    document.getElementById('reminderLabel').textContent = I18N[lang].obligation.reminder;
    const reminderSelect = document.getElementById('reminderTime');
reminderSelect.querySelector('option[value="30"]').textContent = I18N[lang].obligationsList.reminder30;
reminderSelect.querySelector('option[value="60"]').textContent = I18N[lang].obligationsList.reminder60;
reminderSelect.querySelector('option[value="120"]').textContent = I18N[lang].obligationsList.reminder120;
reminderSelect.querySelector('option[value="1440"]').textContent = I18N[lang].obligationsList.reminder1440;
    document.getElementById('urgentLabel').textContent = I18N[lang].obligation.urgent;
document.getElementById('quietHoursLabel').textContent = I18N[lang].obligation.quietHours;
    document.getElementById('saveObligation').textContent = I18N[lang].obligation.save;
document.getElementById('quietHoursLabel').textContent = I18N[lang].obligation.quietHours;
document.getElementById('repeatLabel').textContent = I18N[lang].obligation.repeat;

const repeatSelect = document.getElementById('repeatType');
repeatSelect.querySelector('option[value=""]').textContent = I18N[lang].obligation.repeatNone;
repeatSelect.querySelector('option[value="daily"]').textContent = I18N[lang].obligation.repeatDaily;
repeatSelect.querySelector('option[value="weekly"]').textContent = I18N[lang].obligation.repeatWeekly;
    document.getElementById('cancelObligation').textContent = `âœ–ï¸ ${I18N[lang].obligation.cancel}`;
    document.getElementById('saveObligation').removeAttribute('data-edit-id');
  });

  // BACK IZ FORME
  document.getElementById('backToAddObligation').addEventListener('click', () => {
    showScreen('screen-menu');
  });

  // PODSJETNIK
  document.getElementById('enableReminder').addEventListener('change', (e) => {
    document.getElementById('reminderOptions').classList.toggle('hidden', !e.target.checked);
  });

  // SPREMI ILI AÅ½URIRAJ
  document.getElementById('saveObligation').addEventListener('click', async () => {
  const title = document.getElementById('obligationTitle').value.trim();
  if (!title) {
  alert(I18N[getLang()].popup.newObligationTitle);
  return;
}

  const editIdStr = document.getElementById('saveObligation').dataset.editId;
  const isEdit = !!editIdStr;
  const editId = isEdit ? parseInt(editIdStr, 10) : null;
  const lang = getLang();

  let existing = null;
  if (isEdit) {
    const all = await obligationDB.getAll();
    existing = all.find(o => o.id === editId) || null;
  }

  const obligation = {
    id: isEdit ? editId : Date.now(),
    type: 'obligation',
    title: title,
    note: document.getElementById('obligationNote').value,
    dateTime: document.getElementById('obligationDateTime').value,
    urgent: document.getElementById('urgentObligation')?.checked || false,
    reminder: document.getElementById('enableReminder').checked
      ? document.getElementById('reminderTime').value
      : null,
    repeat: document.getElementById('repeatType')?.value || null,
    customRepeat: isEdit ? (existing?.customRepeat || null) : null,
    repeatPaused: isEdit ? (existing?.repeatPaused || false) : false,
    skipNextRepeat: isEdit ? (existing?.skipNextRepeat || false) : false,
    status: isEdit ? (existing?.status || 'active') : 'active',
    createdAt: isEdit ? (existing?.createdAt || new Date().toISOString()) : new Date().toISOString(),
    lang: lang
  };

  // SPREMI U DB
  await obligationDB.add(obligation);

  // ===== AUTOMATSKA DOZVOLA + ZAKAZIVANJE =====
  const m = await import('./core/notifications.js');

  if (obligation.reminder) {
    const granted = await m.requestNotificationPermission();
    if (!granted) {
      alert(I18N[getLang()].popup.newObligationSaved);
      showScreen('screen-menu');
      return;
    }
  }

  if (isEdit) {
    await m.rescheduleObligationNotification(obligation);
  } else {
    await m.scheduleObligationNotification(obligation);
  }

  alert(
  isEdit
    ? I18N[getLang()].popup.newObligationSaved
    : I18N[getLang()].popup.newObligationSaved
);

  // RESET FORME
  document.getElementById('obligationTitle').value = '';
  document.getElementById('obligationNote').value = '';
  document.getElementById('obligationDateTime').value = '';
  document.getElementById('enableReminder').checked = false;
  document.getElementById('reminderOptions').classList.add('hidden');
  const repeatSelect = document.getElementById('repeatType');
  if (repeatSelect) repeatSelect.value = '';
  document.getElementById('saveObligation').removeAttribute('data-edit-id');

  if (isEdit) {
    showScreen('screen-obligations-list');
    refreshCurrentObligationsView();
  } else {
    showScreen('screen-menu');
  }
});

  // ODUSTANI
  document.getElementById('cancelObligation').addEventListener('click', () => {
    const isEdit = !!document.getElementById('saveObligation').dataset.editId;
    document.getElementById('saveObligation').removeAttribute('data-edit-id');

    if (isEdit) {
      showScreen('screen-obligations-list');
      refreshCurrentObligationsView();
    } else {
      showScreen('screen-menu');
    }
  });

  // PREGLED OBVEZA
  document.getElementById('btnViewObligations').addEventListener('click', () => {
    const popup = document.getElementById('obligationsPopup');
    popup.classList.remove('animate');
    setTimeout(() => popup.style.display = 'none', 300);

    showScreen('screen-obligations-list');
    showListMode();
    renderObligationsList();
  });

  // BACK IZ LISTE
  document.getElementById('backToObligationsList').addEventListener('click', () => {
    showScreen('screen-menu');
  });

  // DATE PICKER
  const dailyDatePicker = document.getElementById('dailyDatePicker');
  if (dailyDatePicker) {
    dailyDatePicker.value = todayISO();
    currentDailyDate = dailyDatePicker.value;

    dailyDatePicker.addEventListener('change', () => {
      if (viewMode !== 'days') return;
      loadDailyForDate(dailyDatePicker.value);
    });
  }

  // TOGGLE LIST/DAY VIEW
  const btnViewByDays = document.getElementById('btnViewByDays');
  if (btnViewByDays) {
    btnViewByDays.addEventListener('click', async () => {
      if (viewMode === 'list') {
        showDailyMode();
        await loadDailyForDate(currentDailyDate || todayISO());
      } else {
        showListMode();
        await renderObligationsList();
      }
    });
  }

  // PROVJERA
obligationDB.getAll().then(async obligations => {
  console.log('UÄitane obveze iz IndexedDB:', obligations);

  // ===== RESCHEDULE ALL FUTURE NOTIFICATIONS =====
  const m = await import('./core/notifications.js');
  await m.rescheduleAllObligations(obligations);
});

// ===== HANDLE NOTIFICATION TAP (deep link) =====
  if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.LocalNotifications) {
    const { LocalNotifications } = Capacitor.Plugins;

    LocalNotifications.addListener('localNotificationActionPerformed', (event) => {
      const data = event?.notification?.extra || {};
      const rawId = data.obligationId;

      if (!rawId) return;

      const id = Number(rawId);

      showScreen('screen-obligations-list');
      showListMode();
      renderObligationsList();

      obligationDB.getAll().then(items => {
        const ob = items.find(o => Number(o.id) === id);
        if (!ob) return;

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const card = document.querySelector(
              `.obligation-card[data-id="${ob.id}"]`
            );

            if (card) {
              card.scrollIntoView({ behavior: 'smooth', block: 'center' });
              card.classList.add('highlight');

              setTimeout(() => {
                card.classList.remove('highlight');
              }, 2000);
            }
          });
        });
      });
    });
  }

  // ===== FINAL FORCE START SCREEN =====
  setTimeout(() => {
    showScreen('screen-lang');
  }, 0);

});
</script>

</body>
</html>