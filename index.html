<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>LifeKompas</title>

  <!-- âœ… CAVEAT FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest-v2.json?v=2" />
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LifeKompas">
  <meta name="theme-color" content="#0d5e32">

  <link rel="stylesheet" href="styles/main.css">
</head>

<body>

<div class="app">

  <!-- LANGUAGE SCREEN -->
  <div id="screen-lang" class="screen active">
    <div class="lang-title-top">LIFE</div>
    <div class="lang-grid-container">
      <div class="lang-row">
        <button class="lang-btn" data-lang="hr">ğŸ‡­ğŸ‡· Hrvatski</button>
        <button class="lang-btn" data-lang="en">ğŸ‡ºğŸ‡¸ English</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="de">ğŸ‡©ğŸ‡ª Deutsch</button>
        <button class="lang-btn" data-lang="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</button>
        <button class="lang-btn" data-lang="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button>
      </div>
      <div class="lang-row">
        <button class="lang-btn" data-lang="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
      </div>
    </div>
    <div class="lang-title-bottom">KOMPAS</div>
  </div>

  <!-- MAIN MENU -->
  <div id="screen-menu" class="screen">
    <button class="back" id="backMenu">â†</button>
    <div class="main-menu-buttons">
      <button class="menu-item" id="btnObligations">ğŸ§­ Obveze</button>
      <button class="menu-item" id="btnContacts">ğŸ‘¥ Kontakti</button>
      <button class="menu-item" id="btnFinances">ğŸ’° Financije</button>
      <button class="menu-item" id="btnHealth">â¤ï¸ Zdravlje</button>
      <button class="menu-item" id="btnDiary">ğŸ““ Dnevnik</button>
    </div>
  </div>

  <!-- POPUP ZA OBVEZE -->
  <div id="obligationsPopup" class="popup-balloon">
    <div class="balloon-content">
      <button class="balloon-btn" id="btnAddObligation">â• Dodaj obvezu</button>
      <button class="balloon-btn" id="btnShopping">ğŸ›’ Kupovina</button>
      <button class="balloon-btn" id="btnViewObligations">ğŸ“… Pregled obveza</button>
    </div>
  </div>

  <!-- EKRAN: DODAVANJE/UREÄIVANJE OBVEZE -->
  <div id="screen-add-obligation" class="screen">
    <button class="back" id="backToAddObligation">â†</button>
    <div class="obligation-form">
      <input type="text" id="obligationTitle" placeholder="Naslov obveze" maxlength="100">
      <textarea id="obligationNote" placeholder="Napomena" rows="3"></textarea>
      
      <label class="datetime-label">
        <span id="obligationDateTimeLabel">Datum i vrijeme</span>
        <input type="datetime-local" id="obligationDateTime">
      </label>

      <label class="reminder-checkbox">
        <input type="checkbox" id="enableReminder">
        <span id="reminderLabel">Podsjetnik</span>
      </label>

      <div id="reminderOptions" class="hidden">
        <select id="reminderTime">
          <option value="30">30 minuta prije</option>
          <option value="60">1 sat prije</option>
          <option value="120">2 sata prije</option>
          <option value="1440">1 dan prije</option>
        </select>
      </div>

      <button id="saveObligation" class="btn-save">ğŸ’¾ Spremi</button>
      <button id="cancelObligation" class="btn-cancel"></button>
    </div>
  </div>

  <!-- EKRAN: PREGLED OBVEZA -->
<div id="screen-obligations-list" class="screen">
  <button class="back" id="backToObligationsList">â†</button>

  <!-- GUMB: PREGLED PO DANIMA -->
  <div class="obligations-toolbar">
    <button id="btnViewByDays" class="toolbar-btn">
      ğŸ“† Pregled po danima
    </button>
  </div>

  <div id="obligationsContainer" class="obligations-list">
    <!-- Obveze Ä‡e se pojaviti ovdje -->
  </div>
</div>

</div> <!-- .app -->

<!-- SKRIPTOVE -->
<script src="core/i18n.js"></script>
<script src="core/db.js"></script>

<script>
  // SET LANGUAGE + SHOW MENU
  function setLanguage(lang) {
    localStorage.setItem('userLang', lang);
    document.documentElement.setAttribute('lang', lang);

    document.getElementById('btnObligations').textContent = I18N[lang].menu.obligations;
    document.getElementById('btnContacts').textContent = I18N[lang].menu.contacts;
    document.getElementById('btnFinances').textContent = I18N[lang].menu.finances;
    document.getElementById('btnHealth').textContent = I18N[lang].menu.health;
    document.getElementById('btnDiary').textContent = I18N[lang].menu.diary;

    document.getElementById('screen-lang').classList.remove('active');
    document.getElementById('screen-menu').classList.add('active');

    setTimeout(() => {
      document.querySelectorAll('.menu-item').forEach((item, i) => {
        setTimeout(() => {
          item.classList.add('animate');
        }, 150 * i);
      });
    }, 50);
  }

  // OTVORI FORMU ZA UREÄIVANJE
  function openEditForm(ob) {
    document.getElementById('screen-obligations-list').classList.remove('active');
    document.getElementById('screen-add-obligation').classList.add('active');

    const lang = localStorage.getItem('userLang') || 'hr';

    document.getElementById('obligationTitle').value = ob.title;
    document.getElementById('obligationNote').value = ob.note || '';
    document.getElementById('obligationDateTime').value = ob.dateTime || '';
    document.getElementById('enableReminder').checked = !!ob.reminder;
    document.getElementById('reminderOptions').classList.toggle('hidden', !ob.reminder);
    if (ob.reminder) {
      document.getElementById('reminderTime').value = ob.reminder;
    }

    document.getElementById('saveObligation').textContent = I18N[lang].obligation.update;
    document.getElementById('saveObligation').dataset.editId = ob.id;
    document.getElementById('cancelObligation').textContent = `âœ–ï¸ ${I18N[lang].obligation.cancel}`;
  }

  // PRIKAZI LISTU OBVEZA
  function renderObligationsList() {
    const container = document.getElementById('obligationsContainer');
    const lang = localStorage.getItem('userLang') || 'hr';
    
    obligationDB.getAll().then(obligations => {
      obligations.sort((a, b) => {
        if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
        if (!a.dateTime) return 1;
        if (!b.dateTime) return -1;
        return new Date(b.dateTime) - new Date(a.dateTime);
      });

      

      if (obligations.length === 0) {
        container.innerHTML = `<div class="empty-list">${I18N[lang].obligationsList.noObligations}</div>`;
        return;
      }

      container.innerHTML = obligations.map(ob => {
        const dt = ob.dateTime ? new Date(ob.dateTime) : null;
        const dateStr = dt ? dt.toLocaleDateString(I18N[lang].lang || 'hr-HR') : 'â€”';
        const timeStr = dt ? dt.toLocaleTimeString(I18N[lang].lang || 'hr-HR', { hour: '2-digit', minute: '2-digit' }) : 'â€”';
        
        let reminderStr = '';
        if (ob.reminder) {
          const key = `reminder${ob.reminder}`;
          reminderStr = I18N[lang].obligationsList[key] || `${ob.reminder} min`;
        }

        const statusText = ob.status === 'done' 
          ? `âœ… ${I18N[lang].obligationsList.statusDone}`
          : `â³ ${I18N[lang].obligationsList.statusActive}`;

        const bgColor = ob.status === 'done' ? '#e8f5e9' : '#e3f2fd';
        const borderColor = ob.status === 'done' ? '#4caf50' : '#2196f3';

        const toggleBtnText = ob.status === 'done' 
          ? I18N[lang].obligationsList.markActive 
          : I18N[lang].obligationsList.markDone;

        return `
          <div class="obligation-card" data-id="${ob.id}" style="background:${bgColor}; border-left:4px solid ${borderColor};">
            <div class="obligation-title">${ob.title}</div>
            ${ob.note ? `<div class="obligation-note">${ob.note}</div>` : ''}
            <div class="obligation-meta">
              <div class="obligation-date">ğŸ“… ${dateStr}</div>
              <div class="obligation-time">â° ${timeStr}</div>
              ${reminderStr ? `<div class="obligation-reminder">ğŸ”” ${reminderStr}</div>` : ''}
              <div class="obligation-status">${statusText}</div>
            </div>
            <button class="obligation-toggle-status" data-id="${ob.id}" data-status="${ob.status}">
              ${toggleBtnText}
            </button>
            <button class="obligation-edit" data-id="${ob.id}">âœï¸ ${I18N[lang].obligationsList.edit}</button>
            <button class="obligation-delete" data-id="${ob.id}">âœ•</button>
          </div>
        `;
      }).join('');

      // PROMJENA STATUSA
      container.querySelectorAll('.obligation-toggle-status').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = parseInt(btn.dataset.id);
          const currentStatus = btn.dataset.status;
          const newStatus = currentStatus === 'done' ? 'active' : 'done';

          try {
            const obligations = await obligationDB.getAll();
            const obligation = obligations.find(o => o.id === id);
            if (obligation) {
              obligation.status = newStatus;
              await obligationDB.add(obligation);
              renderObligationsList();
            }
          } catch (err) {
            console.error('GreÅ¡ka pri aÅ¾uriranju statusa:', err);
          }
        });
      });

      // UREÄIVANJE
      container.querySelectorAll('.obligation-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = parseInt(btn.dataset.id);
          obligationDB.getAll().then(obligations => {
            const ob = obligations.find(o => o.id === id);
            if (ob) openEditForm(ob);
          });
        });
      });

      // BRISANJE
      container.querySelectorAll('.obligation-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = parseInt(btn.dataset.id);
          if (confirm(I18N[lang].obligationsList.deleteConfirm || 'Obrisati obvezu?')) {
            obligationDB.delete(id).then(() => {
              renderObligationsList();
            });
          }
        });
      });
    });
  }

  // EVENT LISTENERS
function showScreen(screenId) {
  const screens = document.querySelectorAll('.screen');
  const next = document.getElementById(screenId);

  screens.forEach(screen => {
    screen.classList.remove('active');
  });

  // mali timeout da browser uhvati transition
  requestAnimationFrame(() => {
    next.classList.add('active');
  });
}
  document.addEventListener('DOMContentLoaded', () => {
    // JEZICI
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        setLanguage(btn.dataset.lang);
      });
    });

    // BACK - MENU
    document.getElementById('backMenu').addEventListener('click', () => {
      document.getElementById('screen-menu').classList.remove('active');
      document.getElementById('screen-lang').classList.add('active');
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('animate');
      });
    });

    // POPUP OBVEZE
    document.getElementById('btnObligations').addEventListener('click', () => {
      const popup = document.getElementById('obligationsPopup');
      const lang = localStorage.getItem('userLang') || 'hr';
      document.getElementById('btnAddObligation').textContent = I18N[lang].menu.addObligation;
      document.getElementById('btnShopping').textContent = I18N[lang].menu.shopping;
      document.getElementById('btnViewObligations').textContent = I18N[lang].menu.viewObligations;
      popup.style.display = 'block';
      setTimeout(() => popup.classList.add('animate'), 10);
    });

    // ZATVORI POPUP
    document.addEventListener('click', (e) => {
      const popup = document.getElementById('obligationsPopup');
      const btn = document.getElementById('btnObligations');
      if (popup.style.display === 'block' && !popup.contains(e.target) && e.target !== btn) {
        popup.classList.remove('animate');
        setTimeout(() => popup.style.display = 'none', 300);
      }
    });

    // FORMA ZA DODAVANJE
    document.getElementById('btnAddObligation').addEventListener('click', () => {
      const popup = document.getElementById('obligationsPopup');
      popup.classList.remove('animate');
      setTimeout(() => popup.style.display = 'none', 300);

      document.getElementById('screen-menu').classList.remove('active');
      document.getElementById('screen-add-obligation').classList.add('active');

      const lang = localStorage.getItem('userLang') || 'hr';
      document.getElementById('obligationTitle').placeholder = I18N[lang].obligation.title;
      document.getElementById('obligationNote').placeholder = I18N[lang].obligation.note;
      document.getElementById('obligationDateTimeLabel').textContent = I18N[lang].obligation.dateTime;
      document.getElementById('reminderLabel').textContent = I18N[lang].obligation.reminder;
      document.getElementById('saveObligation').textContent = I18N[lang].obligation.save;
      document.getElementById('cancelObligation').textContent = `âœ–ï¸ ${I18N[lang].obligation.cancel}`;
      document.getElementById('saveObligation').removeAttribute('data-edit-id');
    });

    // BACK IZ FORME
    document.getElementById('backToAddObligation').addEventListener('click', () => {
      document.getElementById('screen-add-obligation').classList.remove('active');
      document.getElementById('screen-menu').classList.add('active');
    });

    // PODSJETNIK
    document.getElementById('enableReminder').addEventListener('change', (e) => {
      const options = document.getElementById('reminderOptions');
      options.classList.toggle('hidden', !e.target.checked);
    });

    // SPREMI ILI AÅ½URIRAJ
    document.getElementById('saveObligation').addEventListener('click', async () => {
      const title = document.getElementById('obligationTitle').value.trim();
      if (!title) {
        alert('Unesi naslov obveze!');
        return;
      }

      const isEdit = document.getElementById('saveObligation').dataset.editId;
      const obligation = {
        id: isEdit ? parseInt(isEdit) : Date.now(),
        title: title,
        note: document.getElementById('obligationNote').value,
        dateTime: document.getElementById('obligationDateTime').value,
        reminder: document.getElementById('enableReminder').checked
          ? document.getElementById('reminderTime').value
          : null,
        status: isEdit ? null : 'active',
        createdAt: isEdit ? null : new Date().toISOString(),
        lang: localStorage.getItem('userLang') || 'hr'
      };

      try {
        await obligationDB.add(obligation);
        alert(isEdit ? 'Obveza aÅ¾urirana!' : 'Obveza spremljena!');
        
        // Reset forma
        document.getElementById('obligationTitle').value = '';
        document.getElementById('obligationNote').value = '';
        document.getElementById('obligationDateTime').value = '';
        document.getElementById('enableReminder').checked = false;
        document.getElementById('reminderOptions').classList.add('hidden');
        document.getElementById('saveObligation').removeAttribute('data-edit-id');

        // Povratak
        document.getElementById('screen-add-obligation').classList.remove('active');
        if (isEdit) {
          document.getElementById('screen-obligations-list').classList.add('active');
          renderObligationsList();
        } else {
          document.getElementById('screen-menu').classList.add('active');
        }
      } catch (err) {
        alert('GreÅ¡ka pri spremanju!');
      }
    });

    // ODUSTANI
    document.getElementById('cancelObligation').addEventListener('click', () => {
      document.getElementById('screen-add-obligation').classList.remove('active');
      if (document.getElementById('saveObligation').dataset.editId) {
        document.getElementById('screen-obligations-list').classList.add('active');
        document.getElementById('saveObligation').removeAttribute('data-edit-id');
      } else {
        document.getElementById('screen-menu').classList.add('active');
      }
    });

    // PREGLED OBVEZA
    document.getElementById('btnViewObligations').addEventListener('click', () => {
      const popup = document.getElementById('obligationsPopup');
      popup.classList.remove('animate');
      setTimeout(() => popup.style.display = 'none', 300);
      document.getElementById('screen-menu').classList.remove('active');
      document.getElementById('screen-obligations-list').classList.add('active');
      renderObligationsList();
    });

    // BACK IZ LISTE
    document.getElementById('backToObligationsList').addEventListener('click', () => {
      document.getElementById('screen-obligations-list').classList.remove('active');
      document.getElementById('screen-menu').classList.add('active');
    });
// ===== PREGLED PO DANIMA =====
let viewMode = 'list';

const btnViewByDays = document.getElementById('btnViewByDays');

if (btnViewByDays) {
  btnViewByDays.addEventListener('click', () => {
    if (viewMode === 'list') {
      viewMode = 'days';
      btnViewByDays.textContent = 'ğŸ“‹ Pregled kao lista';
      alert('Pregled po danima â€“ uskoro ğŸ˜‰');
    } else {
      viewMode = 'list';
      btnViewByDays.textContent = 'ğŸ“† Pregled po danima';
      renderObligationsList();
    }
  });
}
    // PROVJERA
    obligationDB.getAll().then(obligations => {
      console.log('UÄitane obveze iz IndexedDB:', obligations);
    });
  });
</script>

</body>
</html>